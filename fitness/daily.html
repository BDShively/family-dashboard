<!-- /family-dashboard/fitness/daily.html -->
<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Fitness · Daily Log</title>
<link rel="stylesheet" href="/family-dashboard/css/base.css">
<style>
:root{--card:#111832;--muted:#9db1d1;--fg:#e6eefc;--line:#2b325a}
body{margin:0;font-family:system-ui,Inter;background:#0b1220;color:var(--fg);padding:18px}
a{color:inherit;text-decoration:none}header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.btn{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#0f1330;color:#fff;cursor:pointer}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin-bottom:12px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}@media(max-width:900px){.row{grid-template-columns:1fr}}
label{font-size:12px;color:var(--muted)}
input,select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#0f1330;color:#e6eefc}
table{width:100%;border-collapse:collapse}th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
th{color:var(--muted)}.muted{color:var(--muted);font-size:12px}
.kpis{display:flex;gap:12px;flex-wrap:wrap}.kpi{padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#101832}
.small{font-size:12px}.hidden{display:none}
tr.sel{outline:2px solid #2b6cb0}
</style></head><body>
<header>
  <div><a class="btn" href="/family-dashboard/fitness/index.html">&larr; Fitness</a></div>
  <div id="auth"></div>
</header>

<h1>Daily Log</h1>

<div class="card">
  <div class="row">
    <div><label>Date</label><input id="d_date" type="date"></div>
    <div class="kpis" id="kpis"></div>
  </div>
</div>

<!-- FOOD -->
<div class="card">
  <h3 style="margin-top:0">Food</h3>
  <div class="row">
    <div>
      <label>Search foods</label>
      <input id="food_search" placeholder="Type to filter library">
    </div>
    <div>
      <label>Food</label>
      <select id="lf_food"></select>
      <div class="small muted" id="food_hint"></div>
    </div>
  </div>
  <div class="row" style="margin-top:10px">
    <div><label>Servings</label><input id="lf_serv" type="number" step="0.01" value="1"></div>
    <div style="align-self:end;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="lf_add"    type="button">Add Food</button>
      <button class="btn" id="lf_update" type="button" disabled>Update Selected</button>
      <button class="btn" id="lf_clear"  type="button" disabled>Clear Selection</button>
    </div>
  </div>
</div>

<!-- EXERCISE -->
<div class="card">
  <h3 style="margin-top:0">Exercise</h3>
  <div class="row">
    <div>
      <label>Search exercises</label>
      <input id="ex_search" placeholder="Type to filter library">
    </div>
    <div>
      <label>Exercise</label>
      <select id="le_ex"></select>
      <div class="small muted" id="ex_hint"></div>
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <div><label>Detected type</label><input id="ex_type" readonly></div>
    <div><label>Body Weight (kg) for calorie calc</label><input id="le_wt" type="number" step="0.1" value="80"></div>
  </div>

  <div id="cardio_fields" class="row" style="margin-top:10px">
    <div><label>Minutes</label><input id="le_min" type="number" step="1" value="30"></div>
    <div><label>Distance (optional, mi or km)</label><input id="le_dist" placeholder="e.g., 3 mi"></div>
  </div>

  <div id="strength_fields" class="row hidden" style="margin-top:10px">
    <div><label>Sets × Reps</label><input id="le_sr" placeholder="e.g., 3x8"></div>
    <div><label>Weight per rep</label><input id="le_weight" type="number" step="0.5" placeholder="lb or kg"></div>
    <div><label>Time (optional, minutes)</label><input id="le_time" type="number" step="1" placeholder="0"></div>
  </div>

  <div class="row" style="margin-top:10px">
    <div><label>Notes</label><input id="le_note" placeholder="Auto-fills, editable"></div>
    <div style="align-self:end;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="le_add"    type="button">Add Exercise</button>
      <button class="btn" id="le_update" type="button" disabled>Update Selected</button>
      <button class="btn" id="le_clear"  type="button" disabled>Clear Selection</button>
    </div>
  </div>
</div>

<!-- LIST -->
<div class="card">
  <h3 style="margin-top:0">Entries</h3>
  <table id="d_tbl">
    <thead><tr>
      <th>Type</th><th>Name</th><th>Qty</th><th>Calories</th><th>Notes</th><th>Actions</th>
    </tr></thead><tbody></tbody>
  </table>
</div>

<script type="module">
  import { onAuthStateChanged, auth, signOutUser } from "/family-dashboard/js/firebase-init.js";
  import {
    $, loadFoods, loadExercises, loadDaily, addFoodLog, addExerciseLog,
    deleteLog, updateLog, today
  } from "./fitness.js";

  const LOGIN="/family-dashboard/main/index.html";
  onAuthStateChanged(auth,(u)=>{ if(!u){location.href=LOGIN;return;}
    const c=document.getElementById('auth');
    c.innerHTML=`<span class="muted">${u.email}</span> <a class="btn" href="#" id="signout">Sign out</a>`;
    signout.onclick=(e)=>{e.preventDefault();signOutUser();};
    init();
  });

  let FOOD_LIB=[], EX_LIB=[], SEL=null; // SEL = {id, kind}

  function setDateToToday(){
    const d = new Date(); const p=n=>String(n).padStart(2,'0');
    document.getElementById('d_date').value = `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
  }

  async function init(){
    setDateToToday();
    document.getElementById('d_date').addEventListener('input', refresh);

    FOOD_LIB = await loadFoods();
    EX_LIB   = await loadExercises();

    renderFoodSelect('');
    renderExSelect('');

    document.getElementById('food_search').oninput = (e)=>renderFoodSelect(e.target.value.trim().toLowerCase());
    document.getElementById('ex_search').oninput   = (e)=>renderExSelect(e.target.value.trim().toLowerCase());

    document.getElementById('lf_add').onclick    = onAddFood;
    document.getElementById('le_add').onclick    = onAddExercise;
    document.getElementById('lf_update').onclick = onUpdateFood;
    document.getElementById('le_update').onclick = onUpdateExercise;
    document.getElementById('lf_clear').onclick  = clearSelection;
    document.getElementById('le_clear').onclick  = clearSelection;

    document.getElementById('le_ex').onchange = onExerciseChange;
    ['le_min','le_dist','le_sr','le_weight','le_time'].forEach(id=>{
      const el = document.getElementById(id); if(el) el.addEventListener('input', autoFillNote);
    });

    onExerciseChange();
    await refresh();
  }

  function renderFoodSelect(q){
    const sel = document.getElementById('lf_food');
    const rows = FOOD_LIB.filter(f=> !q || `${f.name} ${f.serving}`.toLowerCase().includes(q));
    sel.innerHTML = rows.map(f=>`<option value="${f.id}">${f.name} · ${f.serving} · ${f.cal} kcal</option>`).join('');
    document.getElementById('food_hint').textContent = rows.length ? `${rows.length} result(s)` : 'Load demo foods if empty.';
  }

  function renderExSelect(q){
    const sel = document.getElementById('le_ex');
    const rows = EX_LIB.filter(x=> !q || `${x.name} ${x.type}`.toLowerCase().includes(q));
    sel.innerHTML = rows.map(x=>`<option value="${x.id}">${x.name} · ${x.type} · MET ${x.met}</option>`).join('');
    document.getElementById('ex_hint').textContent = rows.length ? `${rows.length} result(s)` : 'Load demo exercises if empty.';
    onExerciseChange();
  }

  function onExerciseChange(){
    const id = document.getElementById('le_ex').value;
    const rec = EX_LIB.find(e=>e.id===id);
    const type = rec?.type || 'Cardio';
    document.getElementById('ex_type').value = type;
    const cardio = document.getElementById('cardio_fields');
    const strength = document.getElementById('strength_fields');
    if(type==='Strength'){ cardio.classList.add('hidden'); strength.classList.remove('hidden'); }
    else { strength.classList.add('hidden'); cardio.classList.remove('hidden'); }
    autoFillNote();
  }

  function autoFillNote(){
    const type = document.getElementById('ex_type').value || 'Cardio';
    if(type==='Strength'){
      const sr = document.getElementById('le_sr').value||'';
      const w  = document.getElementById('le_weight').value||'';
      const t  = document.getElementById('le_time').value||'';
      document.getElementById('le_note').value = `${sr}${w? ' @ '+w:''}${t? ' · '+t+' min':''}`.trim();
    }else{
      const m = document.getElementById('le_min').value||'';
      const d = document.getElementById('le_dist').value||'';
      document.getElementById('le_note').value = `${m} min${d? ' · '+d:''}`.trim();
    }
  }

  async function onAddFood(){
    const foodId = document.getElementById('lf_food').value;
    const servings = Number(document.getElementById('lf_serv').value||1);
    if(!foodId || !(servings>0)){ alert('Select a food and servings.'); return; }
    await addFoodLog(document.getElementById('d_date').value, foodId, servings);
    document.getElementById('lf_serv').value='1';
    await refresh();
  }

  async function onAddExercise(){
    const exId = document.getElementById('le_ex').value;
    if(!exId){ alert('Select an exercise.'); return; }
    const type = document.getElementById('ex_type').value||'Cardio';
    const kg = Number(document.getElementById('le_wt').value||80);
    let minutes = 0;
    if(type==='Strength'){
      minutes = Number(document.getElementById('le_time').value||0);
    }else{
      minutes = Number(document.getElementById('le_min').value||0);
    }
    const note = document.getElementById('le_note').value.trim();
    await addExerciseLog(document.getElementById('d_date').value, exId, minutes, kg, note);
    await refresh();
  }

  async function onUpdateFood(){
    if(!SEL || SEL.kind!=='Food'){ return; }
    const foodId   = document.getElementById('lf_food').value;
    const servings = Number(document.getElementById('lf_serv').value||1);
    const f = FOOD_LIB.find(x=>x.id===foodId); if(!f) return;
    const patch = {
      refId: foodId, name: f.name, qty: servings,
      cal: Math.round((f.cal||0)*servings),
      pro: Number(((f.pro||0)*servings).toFixed(1)),
      notes: f.serving
    };
    await updateLog(SEL.id, patch); clearSelection(); await refresh();
  }

  async function onUpdateExercise(){
    if(!SEL || SEL.kind!=='Exercise'){ return; }
    const exId = document.getElementById('le_ex').value;
    const ex = EX_LIB.find(e=>e.id===exId); if(!ex) return;
    const type = ex.type || 'Cardio';
    const kg = Number(document.getElementById('le_wt').value||80);
    let minutes = 0;
    if(type==='Strength'){ minutes = Number(document.getElementById('le_time').value||0); }
    else { minutes = Number(document.getElementById('le_min').value||0); }
    const note = document.getElementById('le_note').value.trim();
    // recalc calories with MET
    const cal = Math.round((ex.met||0) * kg * (minutes/60));
    const patch = { refId: exId, name: ex.name, qty: minutes, cal, notes: note };
    await updateLog(SEL.id, patch); clearSelection(); await refresh();
  }

  function clearSelection(){
    SEL=null;
    document.getElementById('lf_update').disabled=true;
    document.getElementById('lf_clear').disabled=true;
    document.getElementById('le_update').disabled=true;
    document.getElementById('le_clear').disabled=true;
    document.querySelectorAll('#d_tbl tbody tr').forEach(tr=>tr.classList.remove('sel'));
  }

  async function refresh(){
    const d = document.getElementById('d_date').value;
    const {rows, totals} = await loadDaily(d);

    document.getElementById('kpis').innerHTML = [
      `<div class="kpi"><div class="muted">Calories In</div><div>${totals.in}</div></div>`,
      `<div class="kpi"><div class="muted">Calories Out</div><div>${totals.out}</div></div>`,
      `<div class="kpi"><div class="muted">Net</div><div>${totals.in - totals.out}</div></div>`,
      `<div class="kpi"><div class="muted">Protein (g)</div><div>${totals.pro.toFixed(1)}</div></div>`
    ].join('');

    const tb = document.querySelector('#d_tbl tbody');
    tb.innerHTML = rows.map(r=>`<tr data-id="${r.id}" data-kind="${r.kind}">
      <td>${r.kind}</td><td>${r.name}</td><td>${r.qty}</td><td>${r.cal}</td><td>${r.notes||''}</td>
      <td><button class="btn" data-del="${r.id}" type="button">Delete</button></td>
    </tr>`).join('');

    // select for edit
    tb.querySelectorAll('tr').forEach(tr=>{
      tr.onclick = ()=>{
        tb.querySelectorAll('tr').forEach(x=>x.classList.remove('sel'));
        tr.classList.add('sel');
        const id = tr.dataset.id; const kind = tr.dataset.kind;
        SEL = {id, kind};
        if(kind==='Food'){
          const row = rows.find(x=>x.id===id);
          document.getElementById('lf_food').value = row.refId||'';
          document.getElementById('lf_serv').value = row.qty||1;
          document.getElementById('lf_update').disabled=false;
          document.getElementById('lf_clear').disabled=false;
          document.getElementById('le_update').disabled=true;
          document.getElementById('le_clear').disabled=true;
        }else{
          const row = rows.find(x=>x.id===id);
          document.getElementById('le_ex').value = row.refId||'';
          onExerciseChange();
          const type = document.getElementById('ex_type').value||'Cardio';
          if(type==='Strength'){ document.getElementById('le_time').value = row.qty||0; }
          else{ document.getElementById('le_min').value = row.qty||0; }
          document.getElementById('le_note').value = row.notes||'';
          document.getElementById('le_update').disabled=false;
          document.getElementById('le_clear').disabled=false;
          document.getElementById('lf_update').disabled=true;
          document.getElementById('lf_clear').disabled=true;
        }
      };
    });

    // delete buttons
    tb.querySelectorAll('button[data-del]').forEach(b=>{
      b.onclick = async (e)=>{ e.stopPropagation(); await deleteLog(b.dataset.del); clearSelection(); await refresh(); };
    });
  }
</script>
</body></html>
