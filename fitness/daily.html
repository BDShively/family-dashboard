<!-- /family-dashboard/fitness/daily.html -->
<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Fitness 路 Daily Log</title>
<link rel="stylesheet" href="/family-dashboard/css/base.css">
<style>
:root{--card:#111832;--muted:#9db1d1;--fg:#e6eefc;--line:#2b325a}
body{margin:0;font-family:system-ui,Inter;background:#0b1220;color:var(--fg);padding:18px}
a{color:inherit;text-decoration:none}header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.btn{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#0f1330;color:#fff;cursor:pointer}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin-bottom:12px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}@media(max-width:900px){.row{grid-template-columns:1fr}}
label{font-size:12px;color:var(--muted)}
input,select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#0f1330;color:#e6eefc}
table{width:100%;border-collapse:collapse}th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
th{color:var(--muted)}.muted{color:var(--muted);font-size:12px}
.kpis{display:flex;gap:12px;flex-wrap:wrap}.kpi{padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#101832}
</style></head><body>
<header>
  <div><a class="btn" href="/family-dashboard/fitness/index.html">&larr; Fitness</a></div>
  <div id="auth"></div>
</header>

<h1>Daily Log</h1>

<div class="card">
  <div class="row">
    <div><label>Date</label><input id="d_date" type="date"></div>
    <div class="kpis" id="kpis"></div>
  </div>
</div>

<div class="card">
  <h3 style="margin-top:0">Add Food</h3>
  <div class="row">
    <div><label>Food</label><select id="lf_food"></select></div>
    <div><label>Servings</label><input id="lf_serv" type="number" step="0.01" value="1"></div>
  </div>
  <div style="margin-top:10px"><button class="btn" id="lf_add">Add Food</button></div>
</div>

<div class="card">
  <h3 style="margin-top:0">Add Exercise</h3>
  <div class="row">
    <div><label>Exercise</label><select id="le_ex"></select></div>
    <div><label>Minutes</label><input id="le_min" type="number" step="1" value="30"></div>
  </div>
  <div class="row" style="margin-top:10px">
    <div><label>Body Weight (kg) for calc</label><input id="le_wt" type="number" step="0.1" value="80"></div>
    <div><label>Intensity note</label><input id="le_note"></div>
  </div>
  <div style="margin-top:10px"><button class="btn" id="le_add">Add Exercise</button></div>
</div>

<div class="card">
  <h3 style="margin-top:0">Entries</h3>
  <table id="d_tbl">
    <thead><tr>
      <th>Type</th><th>Name</th><th>Qty</th><th>Calories</th><th>Notes</th><th>Actions</th>
    </tr></thead><tbody></tbody>
  </table>
</div>

<script type="module">
  import { onAuthStateChanged, auth, signOutUser } from "/family-dashboard/js/firebase-init.js";
  import { $, loadFoods, loadExercises, loadDaily, addFoodLog, addExerciseLog, deleteLog, today } from "./fitness.js";
  const LOGIN="/family-dashboard/main/index.html";
  onAuthStateChanged(auth,(u)=>{ if(!u){location.href=LOGIN;return;} authUI(u.email); init(); });

  function authUI(email){
    const c=document.getElementById('auth');
    c.innerHTML=`<span class="muted">${email}</span> <a class="btn" href="#" id="signout">Sign out</a>`;
    signout.onclick=(e)=>{e.preventDefault();signOutUser();};
  }

  async function init(){
    $('#d_date').value = today();
    $('#d_date').addEventListener('input', refresh);

    // dropdowns
    const foods = await loadFoods(); $('#lf_food').innerHTML = foods.map(f=>`<option value="${f.id}">${f.name} 路 ${f.serving} 路 ${f.cal} kcal</option>`).join('');
    const exs   = await loadExercises(); $('#le_ex').innerHTML = exs.map(x=>`<option value="${x.id}">${x.name} 路 MET ${x.met}</option>`).join('');

    $('#lf_add').onclick = async ()=>{
      await addFoodLog($('#d_date').value, $('#lf_food').value, Number($('#lf_serv').value||1));
      await refresh();
    };
    $('#le_add').onclick = async ()=>{
      await addExerciseLog($('#d_date').value, $('#le_ex').value, Number($('#le_min').value||0), Number($('#le_wt').value||80), $('#le_note').value.trim());
      await refresh();
    };

    await refresh();
  }

  async function refresh(){
    const d = $('#d_date').value;
    const {rows, totals} = await loadDaily(d);
    // kpis
    $('#kpis').innerHTML = [
      `<div class="kpi"><div class="muted">Calories In</div><div>${totals.in}</div></div>`,
      `<div class="kpi"><div class="muted">Calories Out</div><div>${totals.out}</div></div>`,
      `<div class="kpi"><div class="muted">Net</div><div>${totals.in - totals.out}</div></div>`,
      `<div class="kpi"><div class="muted">Protein (g)</div><div>${totals.pro.toFixed(1)}</div></div>`
    ].join('');

    // table
    const tb = $('#d_tbl tbody');
    tb.innerHTML = rows.map(r=>`<tr>
      <td>${r.kind}</td>
      <td>${r.name}</td>
      <td>${r.qty}</td>
      <td>${r.cal}</td>
      <td>${r.notes||''}</td>
      <td><button class="btn" data-id="${r.id}">Delete</button></td>
    </tr>`).join('');
    tb.querySelectorAll('button[data-id]').forEach(b=>{
      b.onclick = async ()=>{ await deleteLog(b.dataset.id); await refresh(); };
    });
  }
</script>
</body></html>
