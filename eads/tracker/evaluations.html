<!-- /family-dashboard/eads/tracker/evaluations.html -->
<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>EADS · Evaluations</title>
<link rel="stylesheet" href="/family-dashboard/css/base.css">
<style>
:root{--bg:#0b1220;--card:#111832;--muted:#9db1d1;--fg:#e6eefc;--line:#2b325a;--hi:#2b6cb0}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Inter;padding:18px}
a{color:inherit;text-decoration:none}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.btn{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#0f1330;color:#fff;cursor:pointer}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.card{background:#111832;border:1px solid var(--line);border-radius:14px;padding:12px;margin-bottom:12px}
label{font-size:12px;color:var(--muted)}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#0f1330;color:#e6eefc}
.table{width:100%;border-collapse:collapse}.table th,.table td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left}
.table th{color:var(--muted)}
.badge{padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#0e1430;font-size:12px}
.alert{padding:10px;border:1px solid #c53030;background:#2a0f12;color:#ffd6d6;border-radius:10px;margin-bottom:12px;display:none}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
@media(max-width:1000px){.grid2,.grid3{grid-template-columns:1fr}}
.progress{height:10px;background:#0e1430;border:1px solid var(--line);border-radius:999px;overflow:hidden}
.bar{height:100%;background:linear-gradient(90deg,#2b6cb0,#38a169)}
.small{font-size:12px;color:var(--muted)}.mono{font-variant-numeric:tabular-nums}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <div class="row">
    <a class="btn" href="/family-dashboard/eads/tracker/index.html">&larr; EADS Tracker</a>
    <span class="badge">Evaluations</span>
  </div>
  <div id="auth"></div>
</header>

<div id="err" class="alert"></div>

<!-- Create / Edit -->
<div class="card">
  <div class="grid3">
    <div><label>Member</label><input id="f_member" placeholder="Last, First MI"></div>
    <div><label>Rank</label>
      <select id="f_rank">
        <option value="">—</option>
        <optgroup label="Enlisted">
          <option>AB</option><option>Amn</option><option>A1C</option><option>SrA</option>
          <option>SSgt</option><option>TSgt</option><option>MSgt</option>
          <option>SMSgt</option><option>CMSgt</option>
        </optgroup>
        <optgroup label="Officer">
          <option>2Lt</option><option>1Lt</option><option>Capt</option>
          <option>Maj</option><option>Lt Col</option><option>Col</option>
        </optgroup>
        <optgroup label="Other"><option>Civ</option></optgroup>
      </select>
    </div>
    <div><label>Period End</label><input id="f_end" type="date"></div>
  </div>
  <div class="row" style="margin-top:10px">
    <button class="btn" id="save">Save</button>
    <button class="btn" id="update" disabled>Update</button>
    <button class="btn" id="remove" disabled>Delete</button>
    <span id="sel" class="badge">none</span>
  </div>
</div>

<!-- Filters + Sort -->
<div class="card">
  <div class="row">
    <div><label>Search</label><input id="q" placeholder="member"></div>
    <div><label>Year (by Period End)</label><select id="fltYear"></select></div>
    <div><label>Sort by</label>
      <select id="sortField">
        <option value="rank">Rank</option>
        <option value="progress">Progress</option>
        <option value="member">Member</option>
        <option value="end">Period End</option>
      </select>
    </div>
    <div><label>Order</label>
      <select id="sortDir"><option value="asc">Asc</option><option value="desc">Desc</option></select>
    </div>
    <span class="badge" id="count" style="margin-left:auto">0</span>
  </div>
</div>

<!-- List -->
<div class="card">
  <table class="table">
    <thead><tr>
      <th>Member</th><th>Rank</th><th>End</th><th>Suspense</th><th>Current Step</th><th>Progress</th><th></th>
    </tr></thead>
    <tbody id="tbl"></tbody>
  </table>
</div>

<!-- Status / Steps -->
<div class="card">
  <div class="row" style="justify-content:space-between">
    <div>
      <div class="small">Selected</div>
      <div id="hdrSel" class="badge">none</div>
    </div>
    <div>
      <div class="small">Suspense = Period End + 45 days</div>
      <div id="hdrSusp" class="mono">—</div>
    </div>
  </div>

  <div style="margin:10px 0">
    <div class="progress"><div id="pbar" class="bar" style="width:0%"></div></div>
    <div class="row small" style="justify-content:space-between;margin-top:6px">
      <div>Current: <span id="curStep">—</span></div>
      <div><button class="btn" id="complete">Complete Current</button></div>
    </div>
  </div>

  <!-- Date + Note per step -->
  <div class="grid2" id="stepsGrid"></div>
  <div class="row" style="margin-top:10px">
    <button class="btn" id="saveSteps" disabled>Save Step Updates</button>
  </div>
</div>

<script type="module">
import { onAuthStateChanged, auth, signOutUser, db } from "/family-dashboard/js/firebase-init.js";
import { collection, addDoc, getDocs, updateDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const LOGIN="/family-dashboard/main/index.html";
const STEPS = [
  "Flight Draft","SEO Review","Flt Corrections","SEL/CCD Review","Flt Corrections",
  "CC Review","Flt Corrections","Rater Sign","CC Sign","Shirt QC","Ratee Sign","MPF"
];

// rank order for sorting
const RANK_ORDER = {
  "AB":1,"Amn":2,"A1C":3,"SrA":4,"SSgt":5,"TSgt":6,"MSgt":7,"SMSgt":8,"CMSgt":9,
  "2Lt":10,"1Lt":11,"Capt":12,"Maj":13,"Lt Col":14,"Col":15,"Civ":16,"":99
};

const $=(s)=>document.querySelector(s);
const esc=s=>String(s||"").replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':"&quot;","'":"&#39;" }[m]));
function showErr(t){ const e=$("#err"); e.textContent=t||""; e.style.display=t?"block":"none"; }
function iso(d){ return new Date(d).toISOString().slice(0,10); }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

let ROWS=[], SEL=null;

onAuthStateChanged(auth,(u)=>{ if(!u){location.href=LOGIN;return;}
  const c=document.getElementById("auth");
  c.innerHTML='<span class="badge">'+u.email+'</span> <a class="btn" href="#" id="signout">Sign out</a>';
  document.getElementById("signout").onclick=(e)=>{e.preventDefault();signOutUser();};
  init();
});

async function init(){
  $("#save").onclick=onSave; $("#update").onclick=onUpdate; $("#remove").onclick=onDelete;
  $("#q").oninput=render; $("#fltYear").oninput=render; $("#sortField").oninput=render; $("#sortDir").oninput=render;
  $("#complete").onclick=completeCurrent;
  $("#saveSteps").onclick=saveStepUpdates;
  $("#f_end").value = iso(new Date());
  await load();
}

async function load(){
  const snap = await getDocs(collection(db,"eads_evals"));
  ROWS = snap.docs.map(d=>{
    const x=d.data();
    const end = typeof x.periodEnd==="string" ? x.periodEnd : (x.periodEnd?.seconds? iso(x.periodEnd.seconds*1000) : "");
    const suspense = end? iso(addDays(end,45)) : "";
    const steps = Array.isArray(x.steps)
      ? x.steps.map(s=>({name:s.name, date:s.date||"", note:s.note||""}))
      : STEPS.map(n=>({name:n,date:"",note:""}));
    return {
      id:d.id, member:x.member||"", rank:x.rank||"",
      periodEnd:end, suspense, steps,
      curIndex: Number.isFinite(x.curIndex)? x.curIndex : 0,
      createdAt:x.createdAt?.seconds||0
    };
  });
  buildYears(); render();
}

function buildYears(){
  const years = new Set( ROWS.map(r=> (r.periodEnd||"").slice(0,4)).filter(Boolean) );
  years.add(String(new Date().getFullYear()));
  $("#fltYear").innerHTML = `<option value="">All</option>${[...years].sort().map(y=>`<option>${y}</option>`).join("")}`;
}

function progressOf(r){ return Math.round(100 * Math.min(r.curIndex, r.steps.length) / r.steps.length); }

function render(){
  const q=($("#q").value||"").toLowerCase();
  const fy=$("#fltYear").value;
  const sf=$("#sortField").value, dir=$("#sortDir").value;

  let rows = ROWS.filter(r=>{
    const hit = (r.member+" "+r.rank).toLowerCase().includes(q);
    const yr = (r.periodEnd||"").slice(0,4);
    return hit && (!fy || yr===fy);
  });

  rows.sort((a,b)=>{
    const mul = dir==="asc"?1:-1;
    if(sf==="rank") return mul * ((RANK_ORDER[a.rank]||99)-(RANK_ORDER[b.rank]||99));
    if(sf==="progress") return mul * (progressOf(a)-progressOf(b));
    if(sf==="member") return mul * a.member.localeCompare(b.member);
    // end date
    return mul * ( (a.periodEnd||"").localeCompare(b.periodEnd||"") );
  });

  $("#count").textContent = rows.length+" item(s)";

  $("#tbl").innerHTML = rows.map(r=>{
    const pct = progressOf(r);
    return `<tr data-id="${r.id}">
      <td>${esc(r.member)}</td>
      <td>${esc(r.rank||"")}</td>
      <td class="mono">${esc(r.periodEnd||"")}</td>
      <td class="mono">${esc(r.suspense||"")}</td>
      <td>${esc(r.steps[r.curIndex]?.name || "Complete")}</td>
      <td style="min-width:160px"><div class="progress"><div class="bar" style="width:${pct}%"></div></div></td>
      <td><button class="btn open">Open</button></td>
    </tr>`;
  }).join("");

  document.querySelectorAll("#tbl tr .open").forEach(btn=>{
    btn.onclick=()=> select(btn.closest("tr").dataset.id);
  });
}

function select(id){
  SEL=id;
  const r=ROWS.find(x=>x.id===id); if(!r) return;
  $("#sel").textContent="Selected "+id;
  $("#update").disabled=false; $("#remove").disabled=false;

  $("#f_member").value=r.member||"";
  $("#f_rank").value=r.rank||"";
  $("#f_end").value=r.periodEnd||iso(new Date());

  $("#hdrSel").textContent = `${r.member} · ${r.rank||""}`;
  $("#hdrSusp").textContent = r.suspense||"";
  $("#pbar").style.width = progressOf(r)+"%";
  $("#curStep").textContent = r.steps[r.curIndex]?.name || "Complete";

  // step editors: date + note
  $("#stepsGrid").innerHTML = r.steps.map((s,i)=>`
    <div>
      <label>${esc(s.name)}</label>
      <input type="date" data-idx="${i}" value="${esc(s.date||"")}">
      <input type="text" data-note="${i}" placeholder="step note (optional)" value="${esc(s.note||"")}">
    </div>
  `).join("");
  $("#saveSteps").disabled=false;
}

function readEditor(){
  const member=$("#f_member").value.trim(); if(!member){ showErr("Member required"); return null; }
  const rank=$("#f_rank").value||"";
  const end=$("#f_end").value; if(!end){ showErr("Period End required"); return null; }
  const suspense = iso(addDays(end,45));
  return { member, rank, periodEnd:end, suspense };
}

async function onSave(){
  showErr(""); const base=readEditor(); if(!base) return;
  try{
    $("#save").disabled=true;
    await addDoc(collection(db,"eads_evals"), {
      ...base,
      steps: STEPS.map(n=>({name:n,date:"",note:""})),
      curIndex: 0,
      createdAt: serverTimestamp()
    });
    clearSel(); await load();
  }catch(e){ showErr(e.message||String(e)); } finally{ $("#save").disabled=false; }
}

async function onUpdate(){
  if(!SEL) return; showErr(""); const base=readEditor(); if(!base) return;
  try{
    $("#update").disabled=true;
    await updateDoc(doc(db,"eads_evals",SEL), base);
    await load(); select(SEL);
  }catch(e){ showErr(e.message||String(e)); } finally{ $("#update").disabled=false; }
}

async function onDelete(){
  if(!SEL) return; if(!confirm("Delete this evaluation?")) return;
  try{
    $("#remove").disabled=true;
    await deleteDoc(doc(db,"eads_evals",SEL));
    clearSel(); await load();
  }catch(e){ showErr(e.message||String(e)); } finally{ $("#remove").disabled=false; }
}

function clearSel(){
  SEL=null; $("#sel").textContent="none"; $("#update").disabled=true; $("#remove").disabled=true;
  $("#hdrSel").textContent="none"; $("#hdrSusp").textContent="—"; $("#pbar").style.width="0%"; $("#curStep").textContent="—";
  $("#stepsGrid").innerHTML=""; $("#saveSteps").disabled=true;
}

/* Complete current step -> stamp today, advance */
async function completeCurrent(){
  if(!SEL) return;
  const r=ROWS.find(x=>x.id===SEL); if(!r) return;
  const idx=r.curIndex; if(idx>=r.steps.length){ showErr("All steps complete"); return; }
  r.steps[idx].date = iso(new Date());
  r.curIndex = Math.min(idx+1, r.steps.length);
  try{
    await updateDoc(doc(db,"eads_evals",SEL), { steps:r.steps, curIndex:r.curIndex });
    await load(); select(SEL);
  }catch(e){ showErr(e.message||String(e)); }
}

/* Save edited dates and per-step notes */
async function saveStepUpdates(){
  if(!SEL) return;
  const r=ROWS.find(x=>x.id===SEL); if(!r) return;

  [...document.querySelectorAll('#stepsGrid input[type="date"]')].forEach(inp=>{
    const i=Number(inp.dataset.idx); r.steps[i].date = inp.value||"";
  });
  [...document.querySelectorAll('#stepsGrid input[type="text"]')].forEach(inp=>{
    const i=Number(inp.dataset.note); r.steps[i].note = inp.value||"";
  });

  // recompute current index
  let ci = r.steps.findIndex(s=>!s.date);
  if(ci<0) ci=r.steps.length;
  r.curIndex=ci;

  try{
    await updateDoc(doc(db,"eads_evals",SEL), { steps:r.steps, curIndex:r.curIndex });
    await load(); select(SEL);
  }catch(e){ showErr(e.message||String(e)); }
}
</script>
</body></html>
