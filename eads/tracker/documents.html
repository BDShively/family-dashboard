<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>EADS · Documents</title>
<link rel="stylesheet" href="/family-dashboard/css/base.css">
<style>
:root{--card:#111832;--muted:#9db1d1;--fg:#e6eefc;--line:#2b325a;--bg:#0b1220}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,Inter;background:var(--bg);color:var(--fg);padding:18px}
a{color:inherit;text-decoration:none}header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.btn{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#0f1330;color:#fff;cursor:pointer}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin-bottom:12px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}@media(max-width:1000px){.row{grid-template-columns:1fr}}
label{font-size:12px;color:var(--muted)}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#0f1330;color:#e6eefc}
textarea{min-height:80px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
th{color:var(--muted)}
.muted{color:var(--muted);font-size:12px}
.badge{padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#0e1430;font-size:12px}
.alert{padding:10px;border:1px solid #c53030;background:#2a0f12;color:#ffd6d6;border-radius:10px;margin-bottom:12px;display:none}
.bar{position:relative;height:10px;border:1px solid var(--line);border-radius:999px;background:#0e1430;overflow:hidden}
.bar-fill{position:absolute;left:0;top:0;height:100%}
.bar-wrap{display:flex;align-items:center;gap:8px}
.tag{padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#0e1430;font-size:12px}
</style></head>
<body>
<header>
  <div><a class="btn" href="/family-dashboard/eads/tracker/index.html">&larr; EADS Tracker</a></div>
  <div id="auth"></div>
</header>

<h1>Documents</h1>
<div id="err" class="alert"></div>

<!-- Form -->
<div class="card">
  <div class="row">
    <div><label>Title</label><input id="d_title" placeholder="e.g., OPR Shell, EPR Bullets"></div>
    <div><label>Type</label>
      <select id="d_type">
        <option>General</option><option>Awards</option><option>Eval Support</option>
        <option>Checklist</option><option>Template</option><option>Policy</option>
      </select>
    </div>
  </div>
  <div class="row" style="margin-top:10px">
    <div><label>Date</label><input id="d_date" type="date"></div>
    <div><label>Owner</label><input id="d_owner" placeholder="office or person"></div>
  </div>
  <div class="row" style="margin-top:10px">
    <div><label>Status</label>
      <select id="d_status">
        <option>Reviewing</option>
        <option>Awaiting Signature</option>
        <option>Signed</option>
        <option>Complete</option>
      </select>
    </div>
    <div><label>Link / Path</label><input id="d_link" placeholder="https://… or /assets/docs/…"></div>
  </div>
  <div style="margin-top:10px">
    <label>Notes</label><textarea id="d_notes" placeholder="context, where used, references"></textarea>
  </div>
  <div style="margin-top:10px">
    <button class="btn" id="save"   type="button">Save</button>
    <button class="btn" id="update" type="button" disabled>Update</button>
    <button class="btn" id="remove" type="button" disabled>Delete</button>
    <span id="sel" class="muted"></span>
  </div>
</div>

<!-- Filters + Counter -->
<div class="card">
  <div class="row">
    <div><label>Search</label><input id="q" placeholder="title, owner, notes"></div>
    <div>
      <label>Year</label>
      <select id="f_year"><option value="">All</option></select>
    </div>
  </div>
  <div class="row" style="margin-top:10px">
    <div>
      <label>Type</label>
      <select id="f_type">
        <option value="">All</option><option>General</option><option>Awards</option>
        <option>Eval Support</option><option>Checklist</option><option>Template</option><option>Policy</option>
      </select>
    </div>
    <div>
      <label>Status</label>
      <select id="f_status">
        <option value="">All</option>
        <option>Reviewing</option><option>Awaiting Signature</option><option>Signed</option><option>Complete</option>
      </select>
    </div>
  </div>
  <div style="margin:8px 0">
    <span id="count" class="badge">Documents: 0</span>
  </div>

  <table id="tbl" style="margin-top:10px">
    <thead><tr>
      <th>Title</th><th>Type</th><th>Date</th><th>Year</th><th>Owner</th><th>Status</th><th>Link</th><th>Notes</th>
    </tr></thead>
    <tbody></tbody>
  </table>
</div>

<script type="module">
  import { onAuthStateChanged, auth, signOutUser, db } from "/family-dashboard/js/firebase-init.js";
  import { collection, getDocs, addDoc, updateDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const LOGIN="/family-dashboard/main/index.html";
  onAuthStateChanged(auth,(u)=>{ if(!u){location.href=LOGIN;return;}
    const c=document.getElementById('auth');
    c.innerHTML='<span class="muted">'+u.email+'</span> <a class="btn" href="#" id="signout">Sign out</a>';
    document.getElementById('signout').onclick=(e)=>{e.preventDefault();signOutUser();};
    init();
  });

  const $=(s)=>document.querySelector(s);
  let ROWS=[], SEL=null;

  function showErr(m){ const e=$('#err'); e.textContent=m||''; e.style.display=m?'block':'none'; }

  function statusMeta(s){
    switch(s){
      case 'Reviewing': return {pct:25, color:'#d69e2e', label:'25%'};           // amber
      case 'Awaiting Signature': return {pct:50, color:'#3182ce', label:'50%'};  // blue
      case 'Signed': return {pct:75, color:'#7c3aed', label:'75%'};              // violet
      case 'Complete': return {pct:100, color:'#38a169', label:'100%'};          // green
      default: return {pct:0, color:'#4a5568', label:'0%'};
    }
  }

  async function init(){
    $('#save').onclick=onSave; $('#update').onclick=onUpdate; $('#remove').onclick=onDelete;
    $('#q').oninput=render; $('#f_year').oninput=render; $('#f_type').oninput=render; $('#f_status').oninput=render;
    await load();
  }

  async function load(){
    try{
      const snap = await getDocs(collection(db,'eads_documents'));
      ROWS = snap.docs.map(d=>{
        const data=d.data(); const y=yearStr(data.date);
        return { id:d.id, year:y, ...data };
      });
      const years = Array.from(new Set(ROWS.map(r=>r.year).filter(Boolean))).sort((a,b)=>b.localeCompare(a));
      $('#f_year').innerHTML = '<option value="">All</option>' + years.map(y=>`<option>${y}</option>`).join('');
      render();
    }catch(e){ showErr(e.message||String(e)); }
  }

  function render(){
    const q=($('#q').value||'').toLowerCase();
    const yf=$('#f_year').value; const tf=$('#f_type').value; const sf=$('#f_status').value;
    const rows = ROWS
      .filter(r=> !yf || r.year===yf)
      .filter(r=> !tf || r.type===tf)
      .filter(r=> !sf || r.status===sf)
      .filter(r=> !q || JSON.stringify({t:r.title,o:r.owner,n:r.notes}).toLowerCase().includes(q))
      .sort((a,b)=> cmp(dateStr(a.date), dateStr(b.date)));

    const parts=[]; if(yf) parts.push(yf); if(tf) parts.push(tf); if(sf) parts.push(sf);
    $('#count').textContent = `Documents: ${rows.length}${parts.length?' ('+parts.join(' · ')+')':''}`;

    $('#tbl tbody').innerHTML = rows.map(r=>{
      const m=statusMeta(r.status||'');
      return `<tr data-id="${r.id}">
        <td>${esc(r.title)}</td>
        <td>${esc(r.type||'General')}</td>
        <td>${dateStr(r.date)||''}</td>
        <td>${r.year||''}</td>
        <td>${esc(r.owner||'')}</td>
        <td>
          <div class="bar-wrap">
            <div class="bar" style="width:140px"><div class="bar-fill" style="width:${m.pct}%;background:${m.color}"></div></div>
            <span class="tag">${esc(r.status||'')}</span>
          </div>
        </td>
        <td>${linkfmt(r.link)}</td>
        <td>${esc(r.notes||'')}</td>
      </tr>`;
    }).join('');

    document.querySelectorAll('#tbl tbody tr').forEach(tr=>{
      tr.onclick=()=>{
        const id=tr.dataset.id; SEL=id;
        const r = ROWS.find(x=>x.id===id); if(!r) return;
        $('#d_title').value=r.title||''; $('#d_type').value=r.type||'General';
        $('#d_date').value=dateStr(r.date)||''; $('#d_owner').value=r.owner||'';
        $('#d_status').value=r.status||'Reviewing'; $('#d_link').value=r.link||'';
        $('#d_notes').value=r.notes||'';
        $('#update').disabled=false; $('#remove').disabled=false; $('#sel').textContent=`Selected ${id}`;
      };
    });
  }

  function readForm(){
    const title=$('#d_title').value.trim(); if(!title){ showErr('Title is required'); return null; }
    return {
      title,
      type: $('#d_type').value,
      date: $('#d_date').value,
      owner: $('#d_owner').value.trim(),
      status: $('#d_status').value,
      link: $('#d_link').value.trim(),
      notes: $('#d_notes').value.trim()
    };
  }

  async function onSave(){
    showErr('');
    const rec = readForm(); if(!rec) return;
    try{
      $('#save').disabled=true;
      await addDoc(collection(db,'eads_documents'), { ...rec, createdAt: serverTimestamp() });
      clearSel(); await load();
    }catch(e){ showErr(e.message||String(e)); }
    finally{ $('#save').disabled=false; }
  }
  async function onUpdate(){
    if(!SEL) return;
    showErr('');
    const rec = readForm(); if(!rec) return;
    try{
      $('#update').disabled=true;
      await updateDoc(doc(db,'eads_documents',SEL), rec);
      clearSel(); await load();
    }catch(e){ showErr(e.message||String(e)); }
    finally{ $('#update').disabled=false; }
  }
  async function onDelete(){
    if(!SEL) return;
    if(!confirm('Delete this document?')) return;
    try{
      $('#remove').disabled=true;
      await deleteDoc(doc(db,'eads_documents',SEL));
      clearSel(); await load();
    }catch(e){ showErr(e.message||String(e)); }
    finally{ $('#remove').disabled=false; }
  }

  function clearSel(){
    SEL=null;
    ['#d_title','#d_owner','#d_link','#d_notes','#d_date'].forEach(s=>$(s).value='');
    $('#d_type').value='General'; $('#d_status').value='Reviewing';
    $('#update').disabled=true; $('#remove').disabled=true; $('#sel').textContent='';
  }

  // utils
  function dateStr(v){
    if(!v) return '';
    if(typeof v==='string') return v;
    if(v.seconds) return new Date(v.seconds*1000).toISOString().slice(0,10);
    return '';
  }
  function yearStr(v){ const s=dateStr(v); return s? s.slice(0,4):''; }
  function cmp(a,b){ if(a<b) return -1; if(a>b) return 1; return 0; }
  function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function linkfmt(url){
    if(!url) return '';
    if(url.startsWith('http')) return `<a href="${url}" target="_blank">Open</a>`;
    return url;
  }
</script>
</body></html>
