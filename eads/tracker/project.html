<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>EADS Â· Projects</title>
<link rel="stylesheet" href="/family-dashboard/css/base.css">
<style>
:root{--card:#111832;--muted:#9db1d1;--fg:#e6eefc;--line:#2b325a}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,Inter;background:#0b1220;color:var(--fg);padding:18px}
a{color:inherit;text-decoration:none}header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.btn{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#0f1330;color:#fff;cursor:pointer}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.card{background:#111832;border:1px solid var(--line);border-radius:14px;padding:12px;margin-bottom:12px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}@media(max-width:900px){.row{grid-template-columns:1fr}}
label{font-size:12px;color:var(--muted)}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#0f1330;color:#e6eefc}
table{width:100%;border-collapse:collapse}th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
th{color:var(--muted)}.muted{color:var(--muted);font-size:12px}
.alert{padding:10px;border:1px solid #c53030;background:#2a0f12;color:#ffd6d6;border-radius:10px;margin-bottom:12px;display:none}
</style></head><body>
<header>
  <div><a class="btn" href="/family-dashboard/eads/tracker/index.html">&larr; EADS Tracker</a></div>
  <div id="auth"></div>
</header>

<h1>Projects</h1>
<div id="err" class="alert"></div>

<div class="card">
  <div class="row">
    <div><label>Title</label><input id="p_title" placeholder="e.g., Squadron SharePoint rebuild"></div>
    <div><label>Status</label>
      <select id="p_status"><option>Planned</option><option>In Progress</option><option>Blocked</option><option>Complete</option></select>
    </div>
  </div>
  <div class="row" style="margin-top:10px">
    <div><label>Owner</label><input id="p_owner" placeholder="e.g., You or office"></div>
    <div><label>Target Date</label><input id="p_due" type="date"></div>
  </div>
  <div style="margin-top:10px">
    <label>Notes</label><textarea id="p_notes" placeholder="scope, milestones, blockers"></textarea>
  </div>
  <div style="margin-top:10px">
    <button class="btn" id="save"   type="button">Save</button>
    <button class="btn" id="update" type="button" disabled>Update</button>
    <button class="btn" id="remove" type="button" disabled>Delete</button>
    <span id="sel" class="muted"></span>
  </div>
</div>

<div class="card">
  <div class="row">
    <div><label>Search</label><input id="q" placeholder="title, owner, notes"></div>
    <div><label>Status filter</label>
      <select id="flt"><option value="">All</option><option>Planned</option><option>In Progress</option><option>Blocked</option><option>Complete</option></select>
    </div>
  </div>
  <div id="count" class="muted" style="margin:8px 0"></div>
  <table id="tbl">
    <thead><tr>
      <th>Title</th><th>Status</th><th>Owner</th><th>Target</th><th>Notes</th>
    </tr></thead><tbody></tbody>
  </table>
</div>

<script type="module">
  import { onAuthStateChanged, auth, signOutUser, db } from "/family-dashboard/js/firebase-init.js";
  import { collection, getDocs, addDoc, updateDoc, deleteDoc, doc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const LOGIN="/family-dashboard/main/index.html";
  onAuthStateChanged(auth,(u)=>{ if(!u){location.href=LOGIN;return;}
    const c=document.getElementById('auth');
    c.innerHTML=`<span class="muted">${u.email}</span> <a class="btn" href="#" id="signout">Sign out</a>`;
    signout.onclick=(e)=>{e.preventDefault();signOutUser();};
    init();
  });

  const $=(s)=>document.querySelector(s);
  let ROWS=[], SEL=null;

  function showErr(m){ const e=$('#err'); e.textContent=m||''; e.style.display=m?'block':'none'; }

  async function init(){
    $('#save').onclick=onSave; $('#update').onclick=onUpdate; $('#remove').onclick=onDelete;
    $('#q').oninput=render; $('#flt').oninput=render;
    await load();
  }

  async function load(){
    try{
      const snap = await getDocs(query(collection(db,'eads_projects'), orderBy('status')));
      ROWS = snap.docs.map(d=>({id:d.id, ...d.data()}));
      render();
    }catch(e){ showErr(e.message||String(e)); }
  }

  function render(){
    const q = ($('#q').value||'').toLowerCase();
    const f = $('#flt').value;
    const rows = ROWS
      .filter(r=> !q || JSON.stringify(r).toLowerCase().includes(q))
      .filter(r=> !f || r.status===f);
    $('#count').textContent = `${rows.length} result(s)`;
    $('#tbl tbody').innerHTML = rows.map(r=>`<tr data-id="${r.id}">
      <td>${esc(r.title)}</td><td>${esc(r.status)}</td><td>${esc(r.owner)}</td><td>${esc(r.due||'')}</td><td>${esc(r.notes)}</td>
    </tr>`).join('');
    $('#tbl tbody').querySelectorAll('tr').forEach(tr=>{
      tr.onclick=()=>{ SEL=tr.dataset.id; const r=ROWS.find(x=>x.id===SEL); if(!r) return;
        $('#p_title').value=r.title||''; $('#p_status').value=r.status||'Planned';
        $('#p_owner').value=r.owner||''; $('#p_due').value=r.due||''; $('#p_notes').value=r.notes||'';
        $('#update').disabled=false; $('#remove').disabled=false; $('#sel').textContent=`Selected ${SEL}`;
      };
    });
  }

  function readForm(){
    const title=$('#p_title').value.trim(); if(!title){ showErr('Title is required'); return null; }
    return {
      title,
      status: $('#p_status').value,
      owner:  $('#p_owner').value.trim(),
      due:    $('#p_due').value,
      notes:  $('#p_notes').value.trim()
    };
  }

  async function onSave(){
    showErr('');
    const rec = readForm(); if(!rec) return;
    try{
      $('#save').disabled=true;
      await addDoc(collection(db,'eads_projects'), { ...rec, createdAt: serverTimestamp() });
      clearSel(); await load();
    }catch(e){ showErr(e.message||String(e)); }
    finally{ $('#save').disabled=false; }
  }

  async function onUpdate(){
    if(!SEL) return;
    showErr('');
    const rec = readForm(); if(!rec) return;
    try{
      $('#update').disabled=true;
      await updateDoc(doc(db,'eads_projects',SEL), rec);
      clearSel(); await load();
    }catch(e){ showErr(e.message||String(e)); }
    finally{ $('#update').disabled=false; }
  }

  async function onDelete(){
    if(!SEL) return;
    if(!confirm('Delete this project?')) return;
    try{
      $('#remove').disabled=true;
      await deleteDoc(doc(db,'eads_projects',SEL));
      clearSel(); await load();
    }catch(e){ showErr(e.message||String(e)); }
    finally{ $('#remove').disabled=false; }
  }

  function clearSel(){
    SEL=null; ['#p_title','#p_owner','#p_due','#p_notes'].forEach(s=>$(s).value='');
    $('#p_status').value='Planned'; $('#update').disabled=true; $('#remove').disabled=true; $('#sel').textContent='';
  }
  function esc(s){return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
</script>
</body></html>
