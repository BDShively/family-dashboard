<!-- /barn/manager/stalls.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Barn Â· Stalls</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme:{extend:{
        colors:{brand:{bg:'#0b1220',card:'#0f1a2b',ink:'#e6eefc',mute:'#9db1d1',ac:'#2b6cb0'}},
        boxShadow:{card:'0 8px 24px rgba(0,0,0,0.35)'},
        borderRadius:{xl2:'1.25rem'}
      }}
    }
  </script>
  <style>
    .chip{padding:.4rem .7rem;border-radius:.6rem;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);font-size:.8rem}
    .chip.active{outline:2px solid #2b6cb0}
  </style>
</head>
<body class="bg-brand-bg text-brand-ink min-h-screen">
  <div class="max-w-7xl mx-auto p-4 md:p-8">
    <header class="flex items-center justify-between mb-6">
      <a href="/family-dashboard/barn/manager/index.html" class="px-3 py-2 rounded-lg bg-black/30 border border-white/10 hover:border-brand-ac/60">&larr; Manager</a>
      <div id="auth"></div>
    </header>

    <h1 class="text-2xl md:text-3xl font-semibold tracking-tight mb-4">Stalls</h1>

    <section class="grid lg:grid-cols-2 gap-6">
      <!-- Map -->
      <div class="p-4 rounded-xl2 bg-brand-card shadow-card border border-white/5">
        <div class="flex items-center justify-between mb-3">
          <div class="text-sm text-brand-mute">Click a stall to filter</div>
          <div class="flex items-center gap-2">
            <label class="text-sm text-brand-mute">Show</label>
            <select id="statusFilter" class="p-2 rounded-lg bg-black/30 border border-white/10 outline-none focus:border-brand-ac">
              <option value="all">All</option>
              <option value="active">Occupied</option>
              <option value="empty">Empty</option>
              <option value="scheduled">Scheduled</option>
            </select>
            <button id="clearSel" class="px-3 py-2 rounded-lg bg-black/30 border border-white/10 hover:border-brand-ac/60 text-sm">Clear</button>
          </div>
        </div>

        <!-- Image + SVG overlay + top filter chips -->
        <div class="relative w-full">
          <img id="floorImg" src="/family-dashboard/assets/barn_layout.jpg" alt="Barn floor" class="w-full rounded-lg border border-white/10">
          <svg id="overlay" class="absolute inset-0 w-full h-full" preserveAspectRatio="none"></svg>

          <!-- Filter chips -->
          <div class="absolute top-2 left-2 right-2 pointer-events-none">
            <div class="flex flex-wrap gap-2 pointer-events-auto">
              <button class="chip" data-filter="all">All</button>
              <button class="chip" data-filter="active">Occupied</button>
              <button class="chip" data-filter="scheduled">Scheduled</button>
              <button class="chip" data-filter="empty">Empty</button>
              <button id="clearSel2" class="chip">Clear</button>
            </div>
          </div>
        </div>

        <p class="text-xs text-brand-mute mt-2">Image path: <code>/family-dashboard/assets/barn_layout.jpg</code>.</p>
      </div>

      <!-- Details -->
      <div class="p-4 rounded-xl2 bg-brand-card shadow-card border border-white/5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-medium">Selection</h2>
          <button id="addOccBtn" class="px-3 py-2 rounded-lg bg-brand-ac text-white text-sm">Add Occupancy</button>
        </div>

        <div id="selInfo" class="text-brand-mute text-sm mb-3">No stall selected.</div>

        <div class="overflow-auto rounded-xl2 border border-white/5">
          <table class="min-w-full text-sm">
            <thead class="bg-black/20">
              <tr class="text-left">
                <th class="p-3">Stall</th>
                <th class="p-3">Horse</th>
                <th class="p-3">Owner</th>
                <th class="p-3">Status</th>
                <th class="p-3">Start</th>
                <th class="p-3">End</th>
                <th class="p-3">Rate</th>
              </tr>
            </thead>
            <tbody id="occBody" class="divide-y divide-white/5"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Modal -->
    <dialog id="occModal" class="rounded-xl2 bg-brand-card text-brand-ink border border-white/10 p-0 w-full max-w-lg">
      <form id="occForm" class="p-5 grid gap-3">
        <h3 class="text-lg font-medium mb-1">New Occupancy</h3>
        <div class="grid md:grid-cols-2 gap-3">
          <div><label class="text-sm text-brand-mute">Stall</label><input id="mStall" class="w-full p-3 rounded-lg bg-black/30 border border-white/10" readonly></div>
          <div><label class="text-sm text-brand-mute">Rate / month ($)</label><input id="mRate" type="number" step="0.01" class="w-full p-3 rounded-lg bg-black/30 border border-white/10" required></div>
        </div>
        <div class="grid md:grid-cols-2 gap-3">
          <div><label class="text-sm text-brand-mute">Horse</label><input id="mHorse" class="w-full p-3 rounded-lg bg-black/30 border border-white/10" required></div>
          <div><label class="text-sm text-brand-mute">Owner</label><input id="mOwner" class="w-full p-3 rounded-lg bg-black/30 border border-white/10" required></div>
        </div>
        <div class="grid md:grid-cols-2 gap-3">
          <div><label class="text-sm text-brand-mute">Start date</label><input id="mStart" type="date" class="w-full p-3 rounded-lg bg-black/30 border border-white/10" required></div>
          <div><label class="text-sm text-brand-mute">End date</label><input id="mEnd" type="date" class="w-full p-3 rounded-lg bg-black/30 border border-white/10"></div>
        </div>
        <div class="grid gap-3">
          <div><label class="text-sm text-brand-mute">Feed program</label><input id="mFeed" class="w-full p-3 rounded-lg bg-black/30 border border-white/10"></div>
          <div><label class="text-sm text-brand-mute">Training program</label><input id="mTrain" class="w-full p-3 rounded-lg bg-black/30 border border-white/10"></div>
        </div>
        <div class="flex items-center justify-end gap-2 pt-2">
          <button type="button" id="mCancel" class="px-3 py-2 rounded-lg bg-black/30 border border-white/10">Cancel</button>
          <button class="px-3 py-2 rounded-lg bg-brand-ac text-white">Save</button>
        </div>
      </form>
    </dialog>
  </div>

  <script type="module">
    import { auth, onAuthStateChanged, signOutUser } from "/family-dashboard/js/firebase-init.js";
    import { initBarnStalls } from "/family-dashboard/js/barn-stalls.js";

    onAuthStateChanged(auth, (u)=>{
      if(!u){ location.href="/family-dashboard/main/index.html"; return; }
      document.getElementById('auth').innerHTML = `
        <div class="flex items-center gap-2">
          <span class="text-sm text-brand-mute">${u.email}</span>
          <a id="out" class="px-3 py-2 rounded-lg bg-black/30 border border-white/10 hover:border-brand-ac/60" href="#">Sign out</a>
        </div>`;
      document.getElementById('out').onclick = (e)=>{ e.preventDefault(); signOutUser(); };
    });

    initBarnStalls({
      imageSelector: '#floorImg',
      overlaySelector: '#overlay',
      statusFilterSelector: '#statusFilter',
      clearSelector: '#clearSel',
      occBodySelector: '#occBody',
      selInfoSelector: '#selInfo',
      addBtnSelector: '#addOccBtn',
      modalSelector: '#occModal',
      formSelector: '#occForm',
    });
  </script>
</body>
</html>
