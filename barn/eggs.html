<!-- /family-dashboard/barn/eggs.html -->
<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Barn Â· Egg Tracker</title>
<link rel="stylesheet" href="/family-dashboard/css/base.css">
<style>
:root{--bg:#0b1220;--card:#111832;--muted:#9db1d1;--fg:#e6eefc;--line:#2b325a}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Inter;background:var(--bg);color:var(--fg);padding:18px}
a{color:inherit;text-decoration:none}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.btn{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#0f1330;color:#fff;cursor:pointer}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin-bottom:12px}
.row{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px}
@media(max-width:900px){.row{grid-template-columns:1fr 1fr;row-gap:10px}}
label{font-size:12px;color:var(--muted)}
input{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#0f1330;color:#e6eefc}
table{width:100%;border-collapse:collapse}
th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
th{color:var(--muted)}
.kpis{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
.kpi{padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#101832;min-width:150px}
.kpi .muted{color:var(--muted);font-size:12px}
.egg-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:1px solid var(--line);border-radius:999px;background:#0e1430;cursor:pointer}
.egg-svg{width:22px;height:22px;display:block}
.badge{padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#0e1430;font-size:12px}
.muted{color:var(--muted);font-size:12px}
.alert{padding:10px;border:1px solid #c53030;background:#2a0f12;color:#ffd6d6;border-radius:10px;margin-bottom:12px;display:none}
</style></head><body>
<header>
  <div><a class="btn" href="/family-dashboard/barn/index.html">&larr; Barn</a></div>
  <div id="auth"></div>
</header>

<h1>Egg Tracker</h1>
<div id="err" class="alert"></div>

<!-- Range + today controls -->
<div class="card">
  <div class="row">
    <div><label>Start</label><input id="d_start" type="date"></div>
    <div><label>End</label><input id="d_end" type="date"></div>
    <div style="align-self:end;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="btn_range" type="button">Refresh</button>
      <span id="count" class="badge">0 days</span>
    </div>
    <div style="align-self:end">
      <button class="egg-btn" id="btn_add_today" type="button" title="Add 1 egg to today">
        <svg class="egg-svg" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="#e6eefc" d="M12 2c3.5 0 7 5.2 7 9.5S16.9 22 12 22s-7-4.4-7-10.5S8.5 2 12 2z"/>
        </svg>
        <span>+1 Today</span>
      </button>
    </div>
  </div>
  <div class="kpis" id="kpis"></div>
</div>

<!-- Edit/add specific day -->
<div class="card">
  <div class="row">
    <div><label>Date</label><input id="f_date" type="date"></div>
    <div><label>Eggs</label><input id="f_count" type="number" min="0" step="1" placeholder="0"></div>
    <div style="align-self:end;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="save"   type="button">Save</button>
      <button class="btn" id="update" type="button" disabled>Update</button>
      <button class="btn" id="remove" type="button" disabled>Delete</button>
    </div>
    <div style="align-self:end"><span id="sel" class="muted"></span></div>
  </div>
</div>

<!-- Table -->
<div class="card">
  <table id="tbl">
    <thead><tr>
      <th>Date</th><th>Eggs</th>
    </tr></thead>
    <tbody></tbody>
  </table>
</div>

<script type="module">
  import { auth, onAuthStateChanged, signOutUser, db } from "/family-dashboard/js/firebase-init.js";
  import {
    collection, getDocs, addDoc, updateDoc, deleteDoc, doc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const LOGIN="/family-dashboard/main/index.html";
  onAuthStateChanged(auth,(u)=>{
    if(!u){ location.href=LOGIN; return; }
    const c=document.getElementById('auth');
    c.innerHTML=`<span class="muted">${u.email}</span> <a class="btn" href="#" id="signout">Sign out</a>`;
    signout.onclick=(e)=>{e.preventDefault();signOutUser();};
    init();
  });

  const $=(s)=>document.querySelector(s);
  let ROWS=[], SEL=null;

  function showErr(m){ const e=$('#err'); e.textContent=m||''; e.style.display=m?'block':'none'; }

  const iso=(d)=>d.toISOString().slice(0,10);
  function todayISO(){ const d=new Date(); return iso(d); }
  function setDefaultRange(){
    const d=new Date();
    const s=new Date(d.getFullYear(), d.getMonth(), 1);
    const e=new Date(d.getFullYear(), d.getMonth()+1, 0);
    $('#d_start').value=iso(s); $('#d_end').value=iso(e);
    $('#f_date').value=todayISO();
  }

  async function init(){
    setDefaultRange();
    $('#btn_range').onclick=refresh;
    $('#btn_add_today').onclick=addOneToday;
    $('#save').onclick=onSave;
    $('#update').onclick=onUpdate;
    $('#remove').onclick=onDelete;
    await refresh();
  }

  async function refresh(){
    const start=new Date($('#d_start').value+'T00:00:00');
    const end=new Date($('#d_end').value+'T23:59:59');

    const snap = await getDocs(collection(db,'barn_eggs'));
    ROWS = snap.docs.map(d=>{
      const data=d.data();
      const dt = toDate(data.date);
      return { id:d.id, date:dt, dateISO: dt? iso(dt):'', count: Number(data.count||0) };
    }).filter(r=> r.date && r.date>=start && r.date<=end)
      .sort((a,b)=> a.date - b.date);

    $('#count').textContent = `${ROWS.length} days`;
    const total = ROWS.reduce((a,r)=>a+(r.count||0),0);
    $('#kpis').innerHTML = [
      `<div class="kpi"><div class="muted">Total eggs</div><div>${total}</div></div>`,
      `<div class="kpi"><div class="muted">Average / day</div><div>${ROWS.length? (total/ROWS.length).toFixed(1): '0.0'}</div></div>`
    ].join('');

    const tb=$('#tbl tbody');
    tb.innerHTML = ROWS.map(r=>`<tr data-id="${r.id}">
      <td>${r.dateISO}</td><td>${r.count}</td>
    </tr>`).join('');

    tb.querySelectorAll('tr').forEach(tr=>{
      tr.onclick=()=>{
        const r = ROWS.find(x=>x.id===tr.dataset.id); if(!r) return;
        SEL=r.id; $('#f_date').value=r.dateISO; $('#f_count').value=r.count;
        $('#update').disabled=false; $('#remove').disabled=false; $('#sel').textContent=`Selected ${SEL}`;
      };
    });
  }

  async function addOneToday(){
    try{
      const t = todayISO();
      // find if today's doc is already loaded; if not, scan all
      let row = ROWS.find(r=>r.dateISO===t);
      if(!row){
        const snap = await getDocs(collection(db,'barn_eggs'));
        const all = snap.docs.map(d=>({id:d.id, ...d.data()}));
        const found = all.find(x=>toISO(x.date)===t);
        if(found){ row = { id: found.id, dateISO: t, count: Number(found.count||0) }; }
      }
      if(row){
        await updateDoc(doc(db,'barn_eggs',row.id), { count: Number(row.count||0)+1 });
      }else{
        await addDoc(collection(db,'barn_eggs'), { date: t, count: 1, createdAt: serverTimestamp() });
      }
      await refresh();
    }catch(e){ showErr(e.message||String(e)); }
  }

  async function onSave(){
    showErr('');
    const d = $('#f_date').value; const c = Number($('#f_count').value||0);
    if(!d){ showErr('Date required'); return; }
    try{
      await addDoc(collection(db,'barn_eggs'), { date: d, count: c, createdAt: serverTimestamp() });
      clearSel(); await refresh();
    }catch(e){ showErr(e.message||String(e)); }
  }

  async function onUpdate(){
    if(!SEL) return;
    showErr('');
    const d = $('#f_date').value; const c = Number($('#f_count').value||0);
    try{
      await updateDoc(doc(db,'barn_eggs',SEL), { date: d, count: c });
      clearSel(); await refresh();
    }catch(e){ showErr(e.message||String(e)); }
  }

  async function onDelete(){
    if(!SEL) return;
    if(!confirm('Delete this day?')) return;
    try{
      await deleteDoc(doc(db,'barn_eggs',SEL));
      clearSel(); await refresh();
    }catch(e){ showErr(e.message||String(e)); }
  }

  function clearSel(){
    SEL=null; $('#f_count').value=''; $('#f_date').value=todayISO();
    $('#update').disabled=true; $('#remove').disabled=true; $('#sel').textContent='';
  }

  // utils
  function toDate(v){
    if(!v) return null;
    if(typeof v==='string') return new Date(v+'T12:00:00');
    if(v.seconds) return new Date(v.seconds*1000);
    if(v instanceof Date) return v;
    return null;
  }
  function toISO(v){
    if(!v) return '';
    if(typeof v==='string') return v;
    if(v.seconds) return new Date(v.seconds*1000).toISOString().slice(0,10);
    return '';
  }
</script>
</body></html>
