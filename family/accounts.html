<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Family · Account Vault</title>
<link rel="stylesheet" href="/family-dashboard/css/base.css">
<style>
:root{--bg:#0b1220;--card:#111832;--muted:#9db1d1;--fg:#e6eefc;--line:#2b325a}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Inter;padding:18px}
a{color:inherit;text-decoration:none}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.card{background:#111832;border:1px solid var(--line);border-radius:14px;padding:12px;margin-bottom:12px}
.btn{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#0f1330;color:#fff;cursor:pointer}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.badge{padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#0e1430;font-size:12px}
input,select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#0f1330;color:#e6eefc}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:1000px){.grid3,.grid2{grid-template-columns:1fr}}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left}
.table th{color:var(--muted)}
.alert{display:none;padding:10px;border:1px solid #522;background:#2a0f12;color:#ffd6d6;border-radius:10px}
.muted{color:var(--muted);font-size:12px}
.iconbtn{padding:6px 8px}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9999}
.modal .panel{background:#111832;border:1px solid var(--line);border-radius:14px;padding:16px;max-width:420px;width:92%}
.modal .panel h3{margin:0 0 8px 0}
.modal .panel p{margin:0 0 12px 0;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="row">
    <a class="btn" href="/family-dashboard/family/index.html">&larr; Family</a>
    <span class="badge">Account Vault</span>
  </div>
  <div id="auth"></div>
</header>

<div id="err" class="alert"></div>

<!-- Lock / Unlock -->
<div class="card" id="vaultLock">
  <div class="row" style="justify-content:space-between">
    <div>
      <div class="muted">Enter your vault passphrase. It never leaves this browser.</div>
      <div class="grid2" style="margin-top:8px">
        <input id="passphrase" type="password" placeholder="Vault passphrase">
        <div class="row">
          <button class="btn" id="unlockBtn">Unlock</button>
          <button class="btn" id="lockBtn" disabled>Lock</button>
        </div>
      </div>
      <div class="muted" id="metaHint" style="margin-top:6px"></div>
    </div>
    <span class="badge" id="vaultState">Locked</span>
  </div>
</div>

<!-- Add / Edit -->
<div class="card" id="editor" style="display:none">
  <div class="grid3">
    <div><label>Title</label><input id="f_title" placeholder="e.g., USAA, School Portal"></div>
    <div><label>Username</label><input id="f_user" placeholder="username or email"></div>
    <div><label>URL</label><input id="f_url" placeholder="https://..."></div>
    <div><label>Password</label><input id="f_pass" type="password" placeholder="password"></div>
    <div><label>Category</label>
      <select id="f_cat"><option>Financial</option><option>Schools</option><option>Healthcare</option>
        <option>Kids</option><option>Shopping</option><option>Utilities</option>
        <option>Government</option><option selected>Other</option></select>
    </div>
    <div><label>Notes</label><input id="f_notes" placeholder="optional"></div>
  </div>
  <div class="row" style="margin-top:10px">
    <button class="btn" id="save">Save</button>
    <button class="btn" id="update" disabled>Update</button>
    <button class="btn" id="remove" disabled>Delete</button>
    <span id="sel" class="badge">none</span>
    <span class="badge" id="count" style="margin-left:auto">0</span>
  </div>
</div>

<!-- Filters -->
<div class="card" id="filters" style="display:none">
  <div class="row">
    <input id="q" placeholder="Search title, username, url" />
    <select id="sort">
      <option value="cat-title">Sort: Category · Title</option>
      <option value="title">Sort: Title</option>
      <option value="created">Sort: Newest</option>
    </select>
  </div>
</div>

<!-- List -->
<div class="card" id="listWrap" style="display:none">
  <table class="table">
    <thead><tr>
      <th>Title</th><th>Username</th><th>Category</th><th>URL</th><th>Actions</th>
    </tr></thead>
    <tbody id="tbl"></tbody>
  </table>
</div>

<!-- Wrong passphrase modal -->
<div id="modal" class="modal">
  <div class="panel">
    <h3>Incorrect passphrase</h3>
    <p>The passphrase does not match this vault. Try again.</p>
    <div class="row" style="justify-content:flex-end">
      <button class="btn" id="modalClose">OK</button>
    </div>
  </div>
</div>

<script type="module">
import { onAuthStateChanged, auth, signOutUser, db } from "/family-dashboard/js/firebase-init.js";
import { collection, addDoc, getDocs, updateDoc, deleteDoc, doc, serverTimestamp, setDoc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const LOGIN="/family-dashboard/main/index.html";
const COL="vault_entries";       // entries
const META_COL="vault_meta";     // per-user meta with salt+canary
const CANARY_TEXT="vault-ok";    // known plaintext to verify passphrase

const $=(s)=>document.querySelector(s);
const esc=s=>String(s??"").replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':"&quot;","'":"&#39;" }[m]));
const showErr=t=>{const e=$("#err"); e.textContent=t||""; e.style.display=t?"block":"none";}
function b64(buf){return btoa(String.fromCharCode(...new Uint8Array(buf)));}
function ub64(b){return Uint8Array.from(atob(b),c=>c.charCodeAt(0));}

let USER=null, UNLOCKED=false, KEY=null, META_DOC=null, ROWS=[], SEL=null;

// WebCrypto helpers
async function getKeyFromPass(pass, salt, iters=200000){
  const enc=new TextEncoder();
  const base=await crypto.subtle.importKey("raw", enc.encode(pass), "PBKDF2", false, ["deriveKey"]);
  return crypto.subtle.deriveKey(
    {name:"PBKDF2", salt, iterations:iters, hash:"SHA-256"},
    base, {name:"AES-GCM", length:256}, false, ["encrypt","decrypt"]
  );
}
async function encGCM(key, plaintext){
  const iv=crypto.getRandomValues(new Uint8Array(12));
  const ct=await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, new TextEncoder().encode(plaintext));
  return { iv:b64(iv), ct:b64(ct) };
}
async function decGCM(key, ivB64, ctB64){
  const iv=ub64(ivB64);
  const pt=await crypto.subtle.decrypt({name:"AES-GCM", iv}, key, ub64(ctB64));
  return new TextDecoder().decode(pt);
}

// Auth
onAuthStateChanged(auth, async (u)=>{
  if(!u){ location.href=LOGIN; return; }
  USER=u;
  $("#auth").innerHTML = `<span class="badge">${esc(u.email)}</span> <a class="btn" href="#" id="signout">Sign out</a>`;
  $("#signout").onclick=(e)=>{e.preventDefault();signOutUser();};
  $("#unlockBtn").onclick=unlock;
  $("#lockBtn").onclick=lock;
  $("#modalClose").onclick=()=>{$("#modal").style.display="none"; $("#passphrase").focus();}
  bindUI();
  await loadMeta();
  hintMeta();
});

function bindUI(){
  $("#save").onclick=onSave;
  $("#update").onclick=onUpdate;
  $("#remove").onclick=onDelete;
  $("#q").oninput=render;
  $("#sort").oninput=render;
}

async function loadMeta(){
  const ref=doc(db,META_COL,USER.uid);
  const snap=await getDoc(ref);
  if(snap.exists()){ META_DOC=snap.data(); }
}

function hintMeta(){
  const msg = META_DOC? "Existing vault. Enter passphrase to unlock." : "First unlock will initialize your vault.";
  $("#metaHint").textContent = msg;
}

// Unlock with canary verification
async function unlock(){
  try{
    const pass=$("#passphrase").value;
    if(!pass){ showErr("Enter a passphrase."); return; }

    // Create salt or use existing
    if(!META_DOC){
      const salt=crypto.getRandomValues(new Uint8Array(16));
      KEY = await getKeyFromPass(pass, salt, 200000);
      // create canary with this key
      const can = await encGCM(KEY, CANARY_TEXT);
      await setDoc(doc(db,META_COL,USER.uid), { salt:b64(salt), iterations:200000, canary:can, createdAt: serverTimestamp() });
      META_DOC={ salt:b64(salt), iterations:200000, canary:can };
    }else{
      const saltBytes = ub64(META_DOC.salt);
      KEY = await getKeyFromPass(pass, saltBytes, META_DOC.iterations||200000);
      // verify canary; if decrypt fails or text mismatch -> wrong passphrase
      const text = await decGCM(KEY, META_DOC.canary.iv, META_DOC.canary.ct).catch(()=>null);
      if(text !== CANARY_TEXT){
        // wrong passphrase: show modal and stay locked
        $("#modal").style.display="flex";
        $("#vaultState").textContent="Locked";
        $("#lockBtn").disabled=true;
        $("#unlockBtn").disabled=false;
        hideVault();
        return;
      }
    }

    // Success → unlock UI
    UNLOCKED=true;
    $("#vaultState").textContent="Unlocked";
    $("#lockBtn").disabled=false;
    $("#unlockBtn").disabled=true;
    $("#passphrase").value="";
    showVault();
    await loadRows();
    showErr("");
  }catch(e){
    // Any error → treat as wrong passphrase
    $("#modal").style.display="flex";
    hideVault();
  }
}

function lock(){
  UNLOCKED=false; KEY=null; SEL=null;
  $("#vaultState").textContent="Locked";
  $("#lockBtn").disabled=true;
  $("#unlockBtn").disabled=false;
  hideVault();
  $("#tbl").innerHTML="";
  $("#count").textContent="0";
  showErr("");
}

function showVault(){
  $("#editor").style.display="";
  $("#filters").style.display="";
  $("#listWrap").style.display="";
}
function hideVault(){
  $("#editor").style.display="none";
  $("#filters").style.display="none";
  $("#listWrap").style.display="none";
}

// Data
async function loadRows(){
  const qref=query(collection(db,COL), orderBy("category","asc"), orderBy("title","asc"));
  const snap=await getDocs(qref);
  ROWS = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  $("#count").textContent = ROWS.length+" item(s)";
  render();
}

function render(){
  if(!UNLOCKED) return;
  const q=($("#q").value||"").toLowerCase();
  let rows = ROWS.filter(r=>{
    const hay=(r.title+" "+r.username+" "+r.url+" "+r.category).toLowerCase();
    return !q || hay.includes(q);
  });
  const mode=$("#sort").value;
  if(mode==="created") rows.sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
  else if(mode==="title") rows.sort((a,b)=> (a.title||"").localeCompare(b.title||""));
  else rows.sort((a,b)=> (a.category||"").localeCompare(b.category||"") || (a.title||"").localeCompare(b.title||""));

  $("#tbl").innerHTML = rows.map(r=>`
    <tr data-id="${r.id}">
      <td>${esc(r.title||"")}</td>
      <td>${esc(r.username||"")}</td>
      <td>${esc(r.category||"")}</td>
      <td>${r.url?`<a class="btn iconbtn" href="${esc(r.url)}" target="_blank" rel="noopener">Open</a>`:""}</td>
      <td class="row">
        <button class="btn iconbtn edit">Edit</button>
        <button class="btn iconbtn del">Delete</button>
      </td>
    </tr>
  `).join("");

  document.querySelectorAll("#tbl tr").forEach(tr=>{
    const id=tr.dataset.id;
    tr.querySelector(".edit").onclick=()=> select(id);
    tr.querySelector(".del").onclick=()=> removeRow(id);
  });
}

function select(id){
  const r=ROWS.find(x=>x.id===id); if(!r) return;
  SEL=id; $("#sel").textContent="Selected "+id;
  $("#f_title").value=r.title||"";
  $("#f_user").value=r.username||"";
  $("#f_url").value=r.url||"";
  $("#f_cat").value=r.category||"Other";
  $("#f_notes").value=r.notes||"";
  $("#f_pass").value="";
  $("#update").disabled=false; $("#remove").disabled=false;
}

function readForm(){
  const title=$("#f_title").value.trim();
  const username=$("#f_user").value.trim();
  const url=$("#f_url").value.trim();
  const category=$("#f_cat").value;
  const notes=$("#f_notes").value.trim();
  const plain=$("#f_pass").value;
  if(!title){ showErr("Title required"); return null; }
  if(url && !/^https?:\/\//i.test(url)){ showErr("URL must start with http(s)"); return null; }
  return { title, username, url, category, notes, plain };
}

// encrypt/decrypt helpers for passwords
async function encPwd(plain){ const {iv,ct}=await encGCM(KEY, plain); return {iv,enc:ct}; }

async function onSave(){
  if(!UNLOCKED){ showErr("Unlock vault first."); return; }
  const f=readForm(); if(!f) return;
  try{
    $("#save").disabled=true;
    const enc = f.plain ? await encPwd(f.plain) : {iv:"", enc:""};
    await addDoc(collection(db,COL), {
      title:f.title, username:f.username, url:f.url, category:f.category, notes:f.notes,
      iv: enc.iv, enc: enc.enc, ver:1, createdAt: serverTimestamp()
    });
    clearForm(); await loadRows();
  }catch(e){ showErr(e.message||String(e)); } finally{ $("#save").disabled=false; }
}

async function onUpdate(){
  if(!SEL){ showErr("Select a row first."); return; }
  const f=readForm(); if(!f) return;
  try{
    $("#update").disabled=true;
    const patch={ title:f.title, username:f.username, url:f.url, category:f.category, notes:f.notes };
    if(f.plain){ const enc=await encPwd(f.plain); patch.iv=enc.iv; patch.enc=enc.enc; patch.ver=1; }
    await updateDoc(doc(db,COL,SEL), patch);
    await loadRows(); select(SEL);
  }catch(e){ showErr(e.message||String(e)); } finally{ $("#update").disabled=false; }
}

async function onDelete(){ /* unused button */ }

async function removeRow(id){
  if(!confirm("Delete this entry?")) return;
  try{ await deleteDoc(doc(db,COL,id)); if(SEL===id) clearForm(); await loadRows(); }
  catch(e){ showErr(e.message||String(e)); }
}

function clearForm(){
  SEL=null; $("#sel").textContent="none"; $("#update").disabled=true; $("#remove").disabled=true;
  $("#f_title").value=""; $("#f_user").value=""; $("#f_url").value=""; $("#f_cat").value="Other"; $("#f_notes").value=""; $("#f_pass").value="";
}
</script>
</body></html>
