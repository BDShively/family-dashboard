<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Finances · Ledger</title>
<link rel="stylesheet" href="/family-dashboard/css/base.css">
<style>
:root{--bg:#0b1220;--card:#111832;--muted:#9db1d1;--fg:#e6eefc;--line:#2b325a}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,Inter;background:var(--bg);color:var(--fg);padding:18px}
a{color:inherit;text-decoration:none}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.btn{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#0f1330;color:#fff;cursor:pointer}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin-bottom:12px}
.row{display:grid;grid-template-columns:1fr 1fr auto auto;gap:10px}
@media(max-width:900px){.row{grid-template-columns:1fr 1fr;row-gap:10px}}
label{font-size:12px;color:var(--muted)}
input{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#0f1330;color:#e6eefc}
.kpis{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
.kpi{padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#101832;min-width:150px}
.kpi .muted{color:var(--muted);font-size:12px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
th{color:var(--muted)}
.badge{padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#0e1430;font-size:12px}
.muted{color:var(--muted);font-size:12px}
.empty{padding:8px 10px;border:1px dashed var(--line);border-radius:10px;background:#0e1430;color:#b7c6e6}
</style></head><body>
<header>
  <div><a class="btn" href="/family-dashboard/finances/index.html">&larr; Finances</a></div>
  <div id="auth"></div>
</header>

<h1>Ledger</h1>

<div class="card">
  <div class="row">
    <div><label>Start</label><input id="d_start" type="date"></div>
    <div><label>End</label><input id="d_end" type="date"></div>
    <div style="align-self:end"><button class="btn" id="btn_range" type="button">Refresh</button></div>
    <div style="align-self:end"><span id="count" class="badge">0 items</span></div>
  </div>
  <div class="kpis" id="kpis"></div>
</div>

<div class="card">
  <div id="empty" class="empty" style="display:none">No entries in this range.</div>
  <table id="tbl">
    <thead><tr>
      <th>Date</th><th>Type</th><th>Source</th><th>Category</th><th>Amount</th><th>Notes</th>
    </tr></thead>
    <tbody></tbody>
  </table>
</div>

<script type="module">
  import { auth, onAuthStateChanged, signOutUser, db } from "/family-dashboard/js/firebase-init.js";
  import { collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const LOGIN="/family-dashboard/main/index.html";
  onAuthStateChanged(auth,(u)=>{
    if(!u){ location.href=LOGIN; return; }
    const c=document.getElementById('auth');
    c.innerHTML=`<span class="muted">${u.email}</span> <a class="btn" href="#" id="signout">Sign out</a>`;
    signout.onclick=(e)=>{e.preventDefault();signOutUser();};
    init();
  });

  const $ = (s)=>document.querySelector(s);
  const iso = (d)=> d.toISOString().slice(0,10);

  function setDefaultRange(){
    const today = new Date();
    const start = new Date(today.getFullYear(), today.getMonth(), 1);
    const end   = new Date(today.getFullYear(), today.getMonth()+1, 0);
    $('#d_start').value = iso(start);
    $('#d_end').value   = iso(end);
  }

  async function init(){
    setDefaultRange();
    $('#btn_range').onclick = refresh;
    await refresh();
  }

  // get all rows, then filter by date in JS (works for strings or timestamps)
  async function refresh(){
    const btn = $('#btn_range'); btn.disabled=true;
    const startISO = $('#d_start').value;
    const endISO   = $('#d_end').value;
    const start = new Date(startISO+'T00:00:00');
    const end   = new Date(endISO  +'T23:59:59');

    // pull all three collections
    const [incSnap, expSnap, billSnap] = await Promise.all([
      getDocs(collection(db,'fin_income')),
      getDocs(collection(db,'fin_expenses')),
      getDocs(collection(db,'fin_bills'))
    ]);

    const income = incSnap.docs.map(d=>{
      const data=d.data();
      const dt = toDate(data.date);
      return { id:d.id, type:'Income', dateISO: toISO(dt), date:dt, source:data.source||data.name||'—', cat:data.category||'Income', amt:num(data.amount), notes:data.notes||'' };
    });

    const expenses = expSnap.docs.map(d=>{
      const data=d.data();
      const dt = toDate(data.date);
      return { id:d.id, type:'Expense', dateISO: toISO(dt), date:dt, source:data.source||data.vendor||'—', cat:data.category||'Expense', amt:-Math.abs(num(data.amount)), notes:data.notes||'' };
    });

    const bills = billSnap.docs.map(d=>{
      const data=d.data();
      const dt = toDate(data.dueDate);
      const paid = !!data.paid;
      return { id:d.id, type: paid?'Bill (paid)':'Bill', dateISO: toISO(dt), date:dt, source:data.name||'Bill', cat:data.category||'Bills', amt:-Math.abs(num(data.amount)), notes:(data.notes||'')+(paid?' · paid':'') };
    });

    // range filter
    const rows = [...income, ...expenses, ...bills]
      .filter(r=> r.date && r.date>=start && r.date<=end)
      .sort((a,b)=> (a.date - b.date) || (a.type>b.type?1:-1));

    $('#count').textContent = `${rows.length} items`;

    // KPIs
    const sum = rows.reduce((acc,r)=>{ if(r.amt>=0) acc.in+=r.amt; else acc.out+=-r.amt; return acc; }, {in:0,out:0});
    $('#kpis').innerHTML = [
      `<div class="kpi"><div class="muted">Income</div><div>$${fmt(sum.in)}</div></div>`,
      `<div class="kpi"><div class="muted">Expenses</div><div>$${fmt(sum.out)}</div></div>`,
      `<div class="kpi"><div class="muted">Net</div><div>$${fmt(sum.in - sum.out)}</div></div>`
    ].join('');

    // table
    const tb = $('#tbl tbody');
    tb.innerHTML = rows.map(r=>`<tr>
      <td>${r.dateISO||''}</td>
      <td>${r.type}</td>
      <td>${esc(r.source)}</td>
      <td>${esc(r.cat)}</td>
      <td>${money(r.amt)}</td>
      <td>${esc(r.notes)}</td>
    </tr>`).join('');

    // empty state
    $('#empty').style.display = rows.length? 'none':'block';
    btn.disabled=false;
  }

  // helpers
  function toDate(v){
    if(!v) return null;
    if(typeof v==='string') return new Date(v+'T12:00:00'); // avoid TZ shift
    if(v.seconds) return new Date(v.seconds*1000);
    if(v instanceof Date) return v;
    return null;
  }
  function toISO(d){ return d? d.toISOString().slice(0,10) : ''; }
  function num(v){ return v==null?0:Number(v); }
  function fmt(n){ return n.toLocaleString(undefined,{maximumFractionDigits:2}); }
  function money(n){ const s = n>=0? n : -n; return (n<0?'-':'') + '$' + fmt(s); }
  function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
</script>
</body></html>
