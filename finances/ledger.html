<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Finances · Ledger</title>
<link rel="stylesheet" href="/family-dashboard/css/base.css"/>
<style>
:root{--bg:#0b1220;--card:#111832;--muted:#9db1d1;--fg:#e6eefc;--line:#2b325a}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui,Inter}
a{color:inherit;text-decoration:none}
header{display:flex;justify-content:space-between;align-items:center;padding:16px}
.btn{background:#0f1330;border:1px solid var(--line);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
.badge{padding:2px 8px;background:#0e1430;border:1px solid var(--line);border-radius:999px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:12px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
input,select{background:#0f1330;color:#e6eefc;border:1px solid var(--line);border-radius:10px;padding:8px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left}
.table th{color:var(--muted)}
.right{text-align:right}
.alert{display:none;background:#2a0f12;color:#ffd6d6;border:1px solid #522;padding:8px;border-radius:10px;margin:0 12px}
.totals{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.tile{background:#0f1330;border:1px solid var(--line);border-radius:12px;padding:10px}
.tile h4{margin:0 0 6px 0;font-size:12px;color:var(--muted)}
.val{font-variant-numeric:tabular-nums;font-size:18px}
.chartWrap{width:100%;max-width:100%;aspect-ratio:16/6;background:#0f1330;border:1px solid var(--line);border-radius:12px;position:relative;overflow:hidden}
.gridline{stroke:#25305a;stroke-width:1}
.axis{stroke:#2b325a;stroke-width:1}
.pathNet{fill:none;stroke:#6aa0ff;stroke-width:2}
.tick{fill:var(--muted);font-size:10px}
.legend{position:absolute;top:8px;right:10px;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="row">
    <a class="btn" href="/family-dashboard/finances/index.html">&larr; Finances</a>
    <span class="badge">Ledger</span>
  </div>
  <div id="auth"></div>
</header>

<div id="err" class="alert"></div>

<!-- Controls -->
<div class="card">
  <div class="row">
    <label>Start <input id="ledgerStart" type="date"></label>
    <label>End <input id="ledgerEnd" type="date"></label>
    <button id="refresh" class="btn">Refresh</button>
    <button id="exportCsv" class="btn">Export CSV</button>
    <span class="badge" id="count">0 items</span>
  </div>
  <div class="small" style="color:var(--muted)">
    Collections: <code>finances_income</code>, <code>finances_expenses</code>, <code>finances_bills</code>, <code>finances_debts</code>.
    Recurring supported: weekly, biweekly, monthly, quarterly, yearly, semi-monthly (day1/day2).
  </div>
</div>

<!-- Totals -->
<div class="card">
  <div class="totals">
    <div class="tile"><h4>Total Income</h4><div class="val" id="totIncome">$0.00</div></div>
    <div class="tile"><h4>Total Outflow</h4><div class="val" id="totExpense">$0.00</div></div>
    <div class="tile"><h4>Net</h4><div class="val" id="totNet">$0.00</div></div>
  </div>
</div>

<!-- Net line chart -->
<div class="card">
  <div class="chartWrap">
    <svg id="chart" viewBox="0 0 1000 380" preserveAspectRatio="none" aria-label="Daily net chart"></svg>
    <div class="legend">Net (Income − Outflow)</div>
  </div>
</div>

<!-- Ledger table -->
<div class="card">
  <table class="table">
    <thead><tr><th>Date</th><th>Type</th><th>Category/Source</th><th class="right">Amount</th></tr></thead>
    <tbody id="ledgerRows"></tbody>
  </table>
</div>

<script type="module">
import { onAuthStateChanged, auth, signOutUser, db } from "/family-dashboard/js/firebase-init.js";
import { collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const LOGIN="/family-dashboard/main/index.html";
const $=(s)=>document.querySelector(s);
const showErr=(t)=>{const e=$("#err"); e.textContent=t||""; e.style.display=t?"block":"none";};

function todayISO(){ return new Date().toISOString().slice(0,10); }
function monthStartISO(){ const d=new Date(); d.setDate(1); return d.toISOString().slice(0,10); }
function money(n){ const x=Number(n)||0; return x<0? "-$"+Math.abs(x).toFixed(2) : "$"+x.toFixed(2); }

/* tolerant numeric parsing */
function num(v){
  if(v==null) return 0;
  if(typeof v==="number") return v;
  if(typeof v==="string"){ const n=parseFloat(v.replace(/[\$,]/g,"").trim()); return isFinite(n)? n:0; }
  return 0;
}
function firstAmount(obj, keys){
  for(const k of keys){ if(k in obj){ const n=num(obj[k]); if(n!==0) return n; } }
  return num(obj[keys[0]]);
}

/* robust dates */
function toDate(v){
  if(!v) return null;
  if(typeof v==="object" && typeof v.seconds==="number"){ const d=new Date(v.seconds*1000); d.setHours(0,0,0,0); return d; }
  if(v instanceof Date){ const d=new Date(v); d.setHours(0,0,0,0); return d; }
  if(typeof v==="number"){ const d=new Date(v); d.setHours(0,0,0,0); return d; }
  if(typeof v==="string"){
    if(/^\d{4}-\d{2}-\d{2}/.test(v)){ const d=new Date(v); d.setHours(0,0,0,0); return d; }
    if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(v)){ const [m,d,y]=v.split("/").map(Number); const dd=new Date(y,m-1,d); dd.setHours(0,0,0,0); return dd; }
    const d=new Date(v); if(!isNaN(+d)){ d.setHours(0,0,0,0); return d; }
  }
  return null;
}
function fmtISO(d){ return d? new Date(d).toISOString().slice(0,10):""; }
function inRange(d, a, b){ return d && d>=a && d<=b; }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function addMonths(d,n){ const x=new Date(d); x.setMonth(x.getMonth()+n); return x; }
function setDOM(d,day){ const x=new Date(d); const dim=new Date(x.getFullYear(),x.getMonth()+1,0).getDate(); x.setDate(Math.min(day,dim)); return x; }

/* recurrence */
function* genOccurrences(cfg, startD, endD){
  const freq=(cfg.frequency||"").toLowerCase();
  const interval=Number(cfg.interval||1)||1;
  const hardEnd=cfg.endD||null;

  if(freq==="semi-monthly"||freq==="semimonthly"||(cfg.day1&&cfg.day2)){
    const d1=Number(cfg.day1||1), d2=Number(cfg.day2||15);
    let cur = cfg.anchorD || cfg.startD || startD;
    cur = new Date(cur.getFullYear(), cur.getMonth(), 1);
    while(cur<=endD && (!hardEnd || cur<=hardEnd)){
      const a=setDOM(cur,d1), b=setDOM(cur,d2);
      if(a>=startD && a<=endD && (!hardEnd || a<=hardEnd)) yield a;
      if(b>=startD && b<=endD && (!hardEnd || b<=hardEnd)) yield b;
      cur = addMonths(cur, interval);
    }
    return;
  }

  let cur = cfg.anchorD || cfg.startD || startD;
  if((freq==="monthly"||freq==="quarterly"||freq==="yearly") && cfg.dayOfMonth){
    cur = setDOM(cur, Number(cfg.dayOfMonth));
  }
  while(cur<startD){
    if(freq==="weekly") cur=addDays(cur,7*interval);
    else if(freq==="biweekly") cur=addDays(cur,14*interval);
    else if(freq==="monthly") cur=addMonths(cur,interval);
    else if(freq==="quarterly") cur=addMonths(cur,3*interval);
    else if(freq==="yearly") cur=addMonths(cur,12*interval);
    else break;
  }
  while(cur<=endD && (!hardEnd || cur<=hardEnd)){
    yield cur;
    if(freq==="weekly") cur=addDays(cur,7*interval);
    else if(freq==="biweekly") cur=addDays(cur,14*interval);
    else if(freq==="monthly") cur=addMonths(cur,interval);
    else if(freq==="quarterly") cur=addMonths(cur,3*interval);
    else if(freq==="yearly") cur=addMonths(cur,12*interval);
    else break;
  }
}

/* firestore pulls */
async function pullAll(col){ const snap=await getDocs(collection(db,col)); return snap.docs.map(d=>({id:d.id,...d.data()})); }

async function loadLedger(){
  const startD = toDate($("#ledgerStart").value);
  const endD   = toDate($("#ledgerEnd").value);
  if(!startD || !endD){ showErr("Select valid start and end dates."); return; }
  showErr("");

  const [incomes, expenses, bills, debts] = await Promise.all([
    pullAll("finances_income"),
    pullAll("finances_expenses"),
    pullAll("finances_bills"),
    pullAll("finances_debts"),
  ]);

  // Income
  const inc = incomes.map(r=>{
    const d=toDate(r.date||r.receivedDate||r.postedDate);
    const amt=firstAmount(r,["amount","net","gross"]);
    return { d, type:"Income", cat:(r.source||r.category||r.name||""), amt:isFinite(amt)? amt:0 };
  }).filter(x=> inRange(x.d,startD,endD));

  // Expenses one-off
  const expOne = expenses.filter(r=> !(r.recurring||r.frequency||r.isRecurring||r.repeat)).map(r=>{
    const d=toDate(r.date||r.postedDate||r.paidDate);
    const amt=firstAmount(r,["amount","total"]);
    return { d, type:"Expense", cat:(r.category||r.payee||r.name||""), amt: isFinite(amt)? -Math.abs(amt):0 };
  }).filter(x=> inRange(x.d,startD,endD));

  // Expenses recurring
  const expRec = expenses.filter(r=> (r.recurring||r.frequency||r.isRecurring||r.repeat)).flatMap(r=>{
    const amount = firstAmount(r,["amount","total"]);
    const cfg={
      frequency: String(r.frequency||r.repeat||"monthly").toLowerCase(),
      interval: r.interval||1,
      anchorD: toDate(r.anchorDate||r.startDate||r.date),
      startD:  toDate(r.startDate||r.date),
      endD:    toDate(r.endDate),
      dayOfMonth: r.dayOfMonth || r.paymentDay || r.dueDay,
      day1: r.day1, day2: r.day2
    };
    const rows=[];
    for(const d of genOccurrences(cfg,startD,endD)){
      rows.push({ d, type:"Expense", cat:(r.category||r.payee||r.name||""), amt:-Math.abs(Number(amount)||0) });
    }
    return rows;
  });

  // Bills
  const billRows = bills.flatMap(r=>{
    const amount=firstAmount(r,["amount","paymentAmount"]);
    const isRec=(r.recurring||r.frequency||r.isRecurring||r.repeat || r.dayOfMonth || r.day1 || r.day2 || r.paymentDay || r.dueDay);
    if(!isRec){
      const d=toDate(r.dueDate||r.date);
      if(!inRange(d,startD,endD)) return [];
      return [{ d, type:"Bill", cat:(r.name||r.category||""), amt:-Math.abs(amount) }];
    }
    const cfg={
      frequency: String(r.frequency||r.repeat||"monthly").toLowerCase(),
      interval: r.interval||1,
      anchorD: toDate(r.anchorDate||r.startDate||r.dueDate||r.date) || startD,
      startD:  toDate(r.startDate||r.dueDate||r.date) || startD,
      endD:    toDate(r.endDate),
      dayOfMonth: r.dayOfMonth || r.paymentDay || r.dueDay,
      day1: r.day1, day2: r.day2
    };
    const rows=[];
    for(const d of genOccurrences(cfg,startD,endD)){
      rows.push({ d, type:"Bill", cat:(r.name||r.category||""), amt:-Math.abs(Number(amount)||0) });
    }
    return rows;
  });

  // Debts (supports "min")
  const debtRows = debts.flatMap(r=>{
    const amount = firstAmount(r,[
      "paymentAmount","monthlyPayment","minPayment","min","amount","dueAmount","autoPayAmount","installment"
    ]);
    const isRec=(r.recurring||r.frequency||r.isRecurring||r.repeat||r.paymentDay||r.dayOfMonth||r.dueDay);
    if(!isRec){
      const d=toDate(r.date||r.nextDue||r.dueDate);
      if(!inRange(d,startD,endD)) return [];
      return [{ d, type:"Debt", cat:(r.name||r.lender||"Debt"), amt:-Math.abs(amount) }];
    }
    const cfg={
      frequency: String(r.frequency||r.repeat||"monthly").toLowerCase(),
      interval: r.interval||1,
      anchorD: toDate(r.anchorDate||r.startDate||r.nextDue||r.date) || startD,
      startD:  toDate(r.startDate||r.date||r.nextDue) || startD,
      endD:    toDate(r.endDate),
      dayOfMonth: r.dayOfMonth || r.paymentDay || r.dueDay,
      day1: r.day1, day2: r.day2
    };
    const rows=[];
    for(const d of genOccurrences(cfg,startD,endD)){
      rows.push({ d, type:"Debt", cat:(r.name||r.lender||"Debt"), amt:-Math.abs(Number(amount)||0) });
    }
    return rows;
  });

  const rows=[...inc, ...expOne, ...expRec, ...billRows, ...debtRows]
    .filter(x=> x.d instanceof Date && !isNaN(+x.d))
    .sort((a,b)=> a.d - b.d);

  $("#count").textContent=`${rows.length} item(s)`;

  // Table
  const tbody=$("#ledgerRows"); tbody.innerHTML="";
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${fmtISO(r.d)}</td><td>${r.type}</td><td>${r.cat}</td><td class="right">${money(r.amt)}</td>`;
    tbody.appendChild(tr);
  });

  // Totals
  const totIncome = inc.reduce((s,x)=>s+x.amt,0);
  const totOut    = rows.filter(r=>r.amt<0).reduce((s,x)=>s+(-x.amt),0);
  const net       = totIncome - totOut;
  $("#totIncome").textContent  = money(totIncome);
  $("#totExpense").textContent = money(totOut);
  $("#totNet").textContent     = money(net);

  // Daily net series
  const days=[]; let cur=new Date(startD);
  while(cur<=endD){ days.push(new Date(cur)); cur=addDays(cur,1); }
  const byDayNet=new Map();
  rows.forEach(r=>{
    const k=fmtISO(r.d);
    byDayNet.set(k,(byDayNet.get(k)||0)+r.amt);
  });
  const seriesNet=days.map(d=>({x:d, y: byDayNet.get(fmtISO(d))||0}));

  renderNetChart(seriesNet);
}

/* SVG single-line chart for NET */
function renderNetChart(net){
  const svg=$("#chart");
  const W=1000, H=380, padL=50, padR=16, padT=16, padB=28;
  svg.innerHTML="";

  const ys=net.map(p=>p.y);
  const maxAbs=Math.max(10, ...ys.map(v=>Math.abs(v)));
  const yMax=maxAbs, yMin=-maxAbs;

  const xs=net.map(p=>+p.x);
  const minX=Math.min(...xs), maxX=Math.max(...xs);

  const xScale=t=> padL + ( (t-minX)/(maxX-minX||1) )*(W-padL-padR);
  const yScale=v=> H-padB - ((v - yMin)/(yMax - yMin || 1))*(H-padT-padB);

  // zero line
  const zeroY=yScale(0);
  const zero=document.createElementNS("http://www.w3.org/2000/svg","line");
  zero.setAttribute("x1",padL); zero.setAttribute("x2",W-padR);
  zero.setAttribute("y1",zeroY); zero.setAttribute("y2",zeroY);
  zero.setAttribute("class","axis"); svg.appendChild(zero);

  // gridlines (4 each above/below)
  const g=4;
  for(let i=0;i<=g;i++){
    const v = yMin + (i/g)*(yMax-yMin);
    const y = yScale(v);
    const ln=document.createElementNS("http://www.w3.org/2000/svg","line");
    ln.setAttribute("x1",padL); ln.setAttribute("x2",W-padR);
    ln.setAttribute("y1",y); ln.setAttribute("y2",y);
    ln.setAttribute("class","gridline");
    svg.appendChild(ln);

    const t=document.createElementNS("http://www.w3.org/2000/svg","text");
    t.setAttribute("x",8); t.setAttribute("y",y+3);
    t.setAttribute("class","tick"); t.textContent="$"+Math.round(v);
    svg.appendChild(t);
  }

  // x axis
  const ax=document.createElementNS("http://www.w3.org/2000/svg","line");
  ax.setAttribute("x1",padL); ax.setAttribute("x2",W-padR);
  ax.setAttribute("y1",H-padB); ax.setAttribute("y2",H-padB);
  ax.setAttribute("class","axis"); svg.appendChild(ax);

  // x ticks ~6
  const steps=Math.max(1, Math.round((net.length-1)/5));
  for(let i=0;i<net.length;i+=steps){
    const x=xScale(+net[i].x); const y=H-padB;
    const t=document.createElementNS("http://www.w3.org/2000/svg","text");
    t.setAttribute("x",x); t.setAttribute("y",y+16);
    t.setAttribute("text-anchor","middle"); t.setAttribute("class","tick");
    const d=net[i].x; t.textContent=`${d.getMonth()+1}/${d.getDate()}`;
    svg.appendChild(t);
  }

  // path
  function pathString(arr){ return arr.map((p,i)=>`${i?"L":"M"}${xScale(+p.x)},${yScale(p.y)}`).join(" "); }
  const p=document.createElementNS("http://www.w3.org/2000/svg","path");
  p.setAttribute("d", pathString(net));
  p.setAttribute("class","pathNet");
  svg.appendChild(p);
}

/* auth gate */
onAuthStateChanged(auth,(u)=>{
  if(!u){ location.href=LOGIN; return; }
  $("#auth").innerHTML = `<span class="badge">${u.email}</span> <a class="btn" href="#" id="signout">Sign out</a>`;
  $("#signout").onclick=(e)=>{e.preventDefault();signOutUser();};

  $("#ledgerStart").value = monthStartISO();
  $("#ledgerEnd").value   = todayISO();
  $("#refresh").onclick = loadLedger;
  $("#exportCsv").onclick = exportCsv;
  loadLedger();
});

/* export */
function exportCsv(){
  const rows=[["Date","Type","Category/Source","Amount"]];
  document.querySelectorAll("#ledgerRows tr").forEach(tr=>{
    const tds=[...tr.querySelectorAll("td")].map(td=> td.textContent.trim());
    rows.push(tds);
  });
  const csv=rows.map(r=> r.map(c=>{
    const s=String(c??""); return /[",\n]/.test(s)? `"${s.replace(/"/g,'""')}"` : s;
  }).join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="ledger.csv"; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
</script>
</body></html>
