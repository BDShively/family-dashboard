<!-- /family-dashboard/finances/income.html -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Finances · Income</title>
<link rel="stylesheet" href="/family-dashboard/css/base.css"/>
<style>
:root{--bg:#0b1220;--card:#111832;--muted:#9db1d1;--fg:#e6eefc;--line:#2b325a}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui,Inter}
a{color:inherit;text-decoration:none}
header{display:flex;justify-content:space-between;align-items:center;padding:16px}
.card{background:#111832;border:1px solid var(--line);border-radius:14px;padding:12px;margin:12px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.grid{display:grid;gap:10px}
input,select,textarea{background:#0f1330;color:#e6eefc;border:1px solid var(--line);border-radius:10px;padding:8px}
.btn{background:#0f1330;border:1px solid var(--line);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;text-decoration:none}
.btn.danger{background:#2b0f14;border-color:#5a2b2b}
.badge{padding:2px 8px;background:#0e1430;border:1px solid var(--line);border-radius:999px}
.small{font-size:12px;color:var(--muted)}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
.table th{color:var(--muted)}
.right{text-align:right}
.kv{display:grid;grid-template-columns:repeat(6,minmax(160px,1fr));gap:10px}
.tag{padding:2px 6px;border:1px solid var(--line);border-radius:8px;background:#0f1330;font-size:12px;color:var(--muted)}
#toast{display:none;margin:0 12px;padding:8px 10px;border-radius:10px}
#toast.ok{display:block;background:#0f2a1a;border:1px solid #2f6e4a;color:#d9ffea}
#toast.err{display:block;background:#2a0f12;border:1px solid #6a2b2b;color:#ffd6d6}
</style>
</head>
<body>
<header>
  <div class="row">
    <a class="btn" href="/family-dashboard/finances/index.html">&larr; Finances</a>
    <span class="badge">Income</span>
  </div>
  <div id="auth"></div>
</header>

<div id="toast"></div>

<!-- Sources -->
<div class="card">
  <div class="row" style="justify-content:space-between">
    <div class="row">
      <strong>Income Sources</strong>
      <button id="btnNewSrc" class="btn">+ New</button>
    </div>
    <div class="small">Sources: <code>fin_income_sources</code> · Raises: <code>fin_income_raises</code></div>
  </div>

  <!-- Add/Edit Source -->
  <div id="srcForm" class="kv" style="display:none;margin-top:8px">
    <input id="s_name" placeholder="Name (e.g., USAF Pay)">
    <label><span class="small">Cadence</span>
      <select id="s_cadence">
        <option value="semi">Semi-Monthly (1st & 15th)</option>
        <option value="monthly">Monthly</option>
      </select>
    </label>
    <label id="paydayWrap"><span class="small">Pay Day (1–31)</span>
      <input id="s_payday" placeholder="e.g., 1">
    </label>
    <input id="s_amount" placeholder="Base Amount (per paycheck)">
    <label><span class="small">Start Date</span><input id="s_start" type="date"></label>
    <label><span class="small">End Date</span><input id="s_end" type="date"></label>
    <input id="s_notes" placeholder="Notes" style="grid-column:1/-1">
    <div style="grid-column:1/-1" class="row">
      <button id="s_save" class="btn">Save</button>
      <button id="s_cancel" class="btn">Cancel</button>
    </div>
  </div>

  <table class="table" style="margin-top:10px">
    <thead>
      <tr>
        <th>Name</th><th>Cadence</th><th>Pay Day</th><th class="right">Base Amount</th><th>Active</th><th>Notes</th><th class="right">Actions</th>
      </tr>
    </thead>
    <tbody id="srcRows"></tbody>
  </table>
</div>

<!-- Raises -->
<div class="card">
  <div class="row" style="justify-content:space-between">
    <div class="row">
      <strong>Scheduled Raises</strong>
      <span class="tag">Source: <b id="r_srcName">—</b></span>
    </div>
    <div class="row">
      <label><span class="small">Effective</span><input id="r_date" type="date"></label>
      <input id="r_amount" placeholder="New per-pay amount">
      <input id="r_note" placeholder="Note (e.g., step increase)">
      <button id="r_add" class="btn">Add</button>
    </div>
  </div>
  <table class="table" style="margin-top:8px">
    <thead><tr><th>Effective</th><th class="right">New Amount</th><th>Note</th><th class="right">Actions</th></tr></thead>
    <tbody id="raiseRows"></tbody>
  </table>
</div>

<!-- Month view -->
<div class="card">
  <div class="row" style="justify-content:space-between">
    <div class="row">
      <strong>Monthly Income View</strong>
      <label>Month <input id="m_month" type="month"></label>
      <span class="tag">Total for Month: <b id="m_total">$0.00</b></span>
    </div>
    <div class="small">Computed from base amount overridden by any raise effective on/before pay date.</div>
  </div>
  <table class="table" style="margin-top:8px">
    <thead><tr><th>Date</th><th>Source</th><th class="right">Amount</th><th>Basis</th></tr></thead>
    <tbody id="m_rows"></tbody>
  </table>
</div>

<script type="module">
import { onAuthStateChanged, auth, signOutUser, db } from "/family-dashboard/js/firebase-init.js";
import {
  collection, addDoc, updateDoc, deleteDoc, doc, serverTimestamp,
  getDocs, query, where, orderBy
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const LOGIN="/family-dashboard/main/index.html";
const $=s=>document.querySelector(s);

function toast(msg, ok=false){
  const t=$("#toast"); t.textContent=msg||""; t.className = msg? ("ok"+(ok?"":"")).trim() : ""; t.id="toast";
  if(msg) t.className = ok? "ok":"err"; else t.removeAttribute("class");
}
function esc(s){return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}
function money(n){ const x=Number(n)||0; return "$"+x.toFixed(2); }
function parseAmt(v){ return Number(String(v||"").replace(/[\$,]/g,""))||0; }
function localISO(d=new Date()){const tz=d.getTimezoneOffset()*60000;return new Date(d.getTime()-tz).toISOString().slice(0,10);}
function todayISO(){return localISO();}
function yyyymm(d){return localISO(d).slice(0,7);}

const state={ user:null, editSrcId:null, sources:[], raisesBySrc:{}, activeSrcId:null };

onAuthStateChanged(auth,(u)=>{
  if(!u){ location.href=LOGIN; return; }
  state.user=u;
  $("#auth").innerHTML=`<span class="badge">${u.email}</span> <a class="btn" href="#" id="so">Sign out</a>`;
  $("#so").onclick=e=>{e.preventDefault();signOutUser();};
  init();
});

function init(){
  // form wiring
  $("#btnNewSrc").onclick=()=>openSrcForm();
  $("#s_cancel").onclick=closeSrcForm;
  $("#s_save").onclick=saveSrc;
  $("#s_cadence").onchange=togglePayday;
  $("#r_add").onclick=addRaise;
  $("#m_month").value=yyyymm(new Date());
  $("#m_month").onchange=renderMonth;

  // defaults
  $("#s_start").value=todayISO();
  togglePayday();

  loadAll();
}

function togglePayday(){
  const cad=$("#s_cadence").value;
  document.getElementById("paydayWrap").style.display = (cad==="monthly") ? "block":"none";
}

async function loadAll(){
  await loadSources();
  await loadRaisesAll();
  // pick first source for raises panel
  if(state.sources[0]) { setActiveSrc(state.sources[0].id); }
  renderMonth();
}

/* SOURCES */
async function loadSources(){
  const snap=await getDocs(query(
    collection(db,"fin_income_sources"),
    where("owner","==",state.user.email),
    orderBy("name","asc")
  ));
  state.sources=snap.docs.map(d=>({id:d.id,...d.data()}));
  renderSources();
}

function openSrcForm(src=null){
  state.editSrcId = src? src.id:null;
  $("#srcForm").style.display="grid";
  $("#s_name").value = src?.name || "";
  $("#s_cadence").value = src?.cadence || "semi";
  togglePayday();
  $("#s_payday").value = src?.payDay ?? "";
  $("#s_amount").value = src?.baseAmount ?? "";
  $("#s_start").value = src?.startDate || todayISO();
  $("#s_end").value = src?.endDate || "";
  $("#s_notes").value = src?.notes || "";
}

function closeSrcForm(){ $("#srcForm").style.display="none"; state.editSrcId=null; }

async function saveSrc(){
  try{
    const name=$("#s_name").value.trim();
    if(!name){ toast("Name required"); return; }
    const cadence=$("#s_cadence").value; // 'semi' or 'monthly'
    const payload={
      owner: state.user.email,
      name,
      cadence,
      payDay: cadence==="monthly" ? (Number($("#s_payday").value)||null) : null,
      baseAmount: parseAmt($("#s_amount").value),
      startDate: $("#s_start").value || null,
      endDate: $("#s_end").value || null,
      notes: $("#s_notes").value.trim() || "",
      updatedAt: serverTimestamp()
    };
    if(state.editSrcId){
      await updateDoc(doc(db,"fin_income_sources",state.editSrcId), payload);
      toast("Source updated", true);
    }else{
      await addDoc(collection(db,"fin_income_sources"),{...payload,createdAt:serverTimestamp()});
      toast("Source created", true);
    }
    closeSrcForm();
    await loadSources();
    await loadRaisesAll();
    renderMonth();
  }catch(e){ toast(e.message||String(e)); }
}

async function delSrc(id){
  if(!confirm("Delete this income source? (Raises remain until manually removed)")) return;
  await deleteDoc(doc(db,"fin_income_sources",id));
  await loadSources();
  await loadRaisesAll();
  if(state.activeSrcId===id) state.activeSrcId = state.sources[0]?.id || null;
  renderRaises();
  renderMonth();
}

function renderSources(){
  const tb=$("#srcRows"); tb.innerHTML="";
  state.sources.forEach(s=>{
    const active = isActiveInMonth(s, $("#m_month").value) ? "Yes" : "No";
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><a href="#" data-open="${s.id}">${esc(s.name)}</a></td>
      <td>${s.cadence==="monthly"?"Monthly":"Semi-Monthly"}</td>
      <td>${s.cadence==="monthly"?(s.payDay||"-"):"—"}</td>
      <td class="right">${money(s.baseAmount||0)}</td>
      <td>${active}</td>
      <td>${esc(s.notes||"")}</td>
      <td class="right">
        <button class="btn" data-edit="${s.id}">Edit</button>
        <button class="btn danger" data-del="${s.id}">Delete</button>
      </td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll("button[data-edit]").forEach(b=>{
    b.onclick=()=>openSrcForm(state.sources.find(x=>x.id===b.dataset.edit));
  });
  tb.querySelectorAll("button[data-del]").forEach(b=>{
    b.onclick=()=>delSrc(b.dataset.del);
  });
  tb.querySelectorAll("a[data-open]").forEach(a=>{
    a.onclick=(e)=>{e.preventDefault(); setActiveSrc(a.dataset.open);};
  });
}

/* RAISES */
async function loadRaisesAll(){
  // load all raises for the current user, grouped by source
  const snap=await getDocs(query(
    collection(db,"fin_income_raises"),
    where("owner","==",state.user.email),
    orderBy("effectiveDate","asc")
  ));
  state.raisesBySrc = {};
  snap.docs.forEach(d=>{
    const r={id:d.id,...d.data()};
    (state.raisesBySrc[r.sourceId] ||= []).push(r);
  });
}

function setActiveSrc(id){
  state.activeSrcId = id;
  const src = state.sources.find(s=>s.id===id);
  $("#r_srcName").textContent = src? src.name : "—";
  renderRaises();
}

function renderRaises(){
  const tb=$("#raiseRows"); tb.innerHTML="";
  const list = state.raisesBySrc[state.activeSrcId] || [];
  list.sort((a,b)=> (a.effectiveDate<b.effectiveDate? -1: 1));
  list.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r.effectiveDate||""}</td>
      <td class="right">${money(r.newAmount||0)}</td>
      <td>${esc(r.note||"")}</td>
      <td class="right"><button class="btn danger" data-del="${r.id}">Delete</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll("button[data-del]").forEach(b=>{
    b.onclick=()=>delRaise(b.dataset.del);
  });
}

async function addRaise(){
  try{
    const sid = state.activeSrcId;
    if(!sid){ toast("Select a source (click its name)"); return; }
    const eff = $("#r_date").value;
    const amt = parseAmt($("#r_amount").value);
    if(!eff || !amt){ toast("Effective date and amount required"); return; }
    await addDoc(collection(db,"fin_income_raises"),{
      owner: state.user.email,
      sourceId: sid,
      effectiveDate: eff,
      newAmount: amt,
      note: $("#r_note").value.trim() || "",
      createdAt: serverTimestamp()
    });
    $("#r_amount").value=""; $("#r_note").value="";
    await loadRaisesAll();
    renderRaises();
    renderMonth();
    toast("Raise added", true);
  }catch(e){ toast(e.message||String(e)); }
}

async function delRaise(id){
  if(!confirm("Delete this raise?")) return;
  await deleteDoc(doc(db,"fin_income_raises",id));
  await loadRaisesAll();
  renderRaises();
  renderMonth();
}

/* MONTH VIEW */
function isActiveInMonth(src, yymm){
  const start = src.startDate || "0000-01-01";
  const end = src.endDate || "9999-12-31";
  const firstOfMonth = yymm + "-01";
  return (firstOfMonth >= start && firstOfMonth <= end);
}

function amountOnDate(src, dateISO){
  // find latest raise on/before date, else base
  const raises = (state.raisesBySrc[src.id]||[]).filter(r=>r.effectiveDate && r.effectiveDate<=dateISO);
  if(raises.length){
    raises.sort((a,b)=> a.effectiveDate<b.effectiveDate ? -1: 1);
    return Number(raises[raises.length-1].newAmount||0);
  }
  return Number(src.baseAmount||0);
}

function payDatesFor(src, yymm){
  const [y,m] = yymm.split("-").map(n=>+n);
  const dates=[];
  if(src.cadence==="semi"){
    dates.push(localISO(new Date(y, m-1, 1)));
    dates.push(localISO(new Date(y, m-1, 15)));
  }else{
    const day = Math.min(Math.max(1, Number(src.payDay||1)), new Date(y, m, 0).getDate());
    dates.push(localISO(new Date(y, m-1, day)));
  }
  // filter active range
  return dates.filter(d=>{
    const st=src.startDate||"0000-01-01"; const en=src.endDate||"9999-12-31";
    return d>=st && d<=en;
  });
}

function renderMonth(){
  const yymm = $("#m_month").value;
  const tb = $("#m_rows"); tb.innerHTML="";
  let total=0;

  // build rows across all sources
  const rows=[];
  state.sources.forEach(src=>{
    if(!isActiveInMonth(src, yymm)) return;
    const dates = payDatesFor(src, yymm);
    dates.forEach(d=>{
      const amt = amountOnDate(src, d);
      const basis = (state.raisesBySrc[src.id]||[]).some(r=>r.effectiveDate && r.effectiveDate<=d) ? "Raised" : "Base";
      rows.push({date:d, name:src.name, amount:amt, basis});
    });
  });

  rows.sort((a,b)=> a.date<b.date? -1: 1);

  rows.forEach(r=>{
    total += r.amount;
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r.date}</td><td>${esc(r.name)}</td>
      <td class="right">${money(r.amount)}</td><td>${r.basis}</td>`;
    tb.appendChild(tr);
  });

  $("#m_total").textContent = money(total);
}
</script>
</body>
</html>
